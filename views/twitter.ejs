<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %></title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: #1da1f2;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-links a:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Form Elements */
        .field {
            margin-bottom: 20px;
        }

        .field label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2d3748;
            display: block;
            font-size: 15px;
        }

        .field input,
        .field textarea,
        .field select {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
            font-family: inherit;
            background: rgba(255, 255, 255, 0.8);
        }

        .field input:focus,
        .field textarea:focus,
        .field select:focus {
            outline: none;
            border-color: #1da1f2;
            box-shadow: 0 0 0 4px rgba(29, 161, 242, 0.1);
            background: rgba(255, 255, 255, 1);
        }

        /* Buttons */
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1da1f2 0%, #0d8bd9 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(29, 161, 242, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(29, 161, 242, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
            margin-top: 15px;
        }

        .btn-secondary:hover {
            transform: translateY(-3px);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        /* Messages */
        .message {
            display: none;
            padding: 20px 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 500;
            animation: slideIn 0.4s ease-out;
            border-left: 5px solid;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .message.success {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border-left-color: #10b981;
        }

        .message.error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border-left-color: #ef4444;
        }

        /* Info Box */
        .info-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 5px solid #1da1f2;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            color: #0c4a6e;
            font-size: 14px;
        }

        /* Character Count */
        .char-count {
            text-align: right;
            font-size: 13px;
            color: #64748b;
            margin-top: 8px;
            font-weight: 500;
        }

        .char-count.warning {
            color: #f59e0b;
        }

        .char-count.error {
            color: #ef4444;
        }

        /* Title List */
        #titlesList {
            background: rgba(248, 250, 252, 0.8);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }
            
            .header, .card {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .nav-links {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1><i class="fab fa-twitter"></i> Twitter Auto Post</h1>
            <div class="nav-links">
                <a href="/"><i class="fas fa-home"></i> Trang chá»§</a>
                <a href="/docx"><i class="fas fa-file-word"></i> DOCX</a>
            </div>
        </div>

        <div id="msg" class="message"></div>

        <% if (!hasKeys) { %>
            <div class="card">
                <h2><i class="fas fa-key"></i> Cáº¥u hÃ¬nh Twitter API</h2>
                <div class="info-box">
                    <i class="fas fa-info-circle"></i> Cáº§n cáº¥u hÃ¬nh Twitter API keys Ä‘á»ƒ sá»­ dá»¥ng tÃ­nh nÄƒng Ä‘Äƒng tweet
                </div>
                <div class="field">
                    <label><i class="fas fa-code"></i> App Key</label>
                    <input id="appKey" type="text" placeholder="Nháº­p App Key..." value="<%= cfg.appKey || '' %>" />
                </div>
                <div class="field">
                    <label><i class="fas fa-lock"></i> App Secret</label>
                    <input id="appSecret" type="password" placeholder="Nháº­p App Secret..." value="<%= cfg.appSecret || '' %>" />
                </div>
                <div class="field">
                    <label><i class="fas fa-ticket-alt"></i> Access Token</label>
                    <input id="accessToken" type="text" placeholder="Nháº­p Access Token..." value="<%= cfg.accessToken || '' %>" />
                </div>
                <div class="field">
                    <label><i class="fas fa-shield-alt"></i> Access Secret</label>
                    <input id="accessSecret" type="password" placeholder="Nháº­p Access Secret..." value="<%= cfg.accessSecret || '' %>" />
                </div>
                <button class="btn btn-primary" onclick="saveKeys()">
                    <i class="fas fa-save"></i> LÆ°u cáº¥u hÃ¬nh
                </button>
            </div>
        <% } else { %>
            <div class="card">
                <h2><i class="fas fa-database"></i> Láº¥y dá»¯ liá»‡u tá»« API theo Page</h2>
                
                <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
                    <div class="field" style="flex: 1; min-width: 200px;">
                        <label><i class="fas fa-link"></i> URL API Base</label>
                        <input id="apiBaseUrl" type="text" placeholder="URL API..." value="https://beiyong.slapibf.com/api.php/provide/art/?ac=detail&t=72" />
                    </div>
                    <div class="field" style="width: 100px;">
                        <label><i class="fas fa-file-alt"></i> Page</label>
                        <input id="apiPage" type="number" min="1" value="1" />
                    </div>
                    <button class="btn btn-success" onclick="fetchPageData()" style="height: 50px;">
                        <i class="fas fa-download"></i> Láº¥y Page
                    </button>
                </div>
                
                <div style="margin-top: 20px; padding: 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h3 style="color: white; margin-bottom: 10px; font-size: 24px; font-weight: 700;">
                            <i class="fas fa-rocket"></i> Tá»° Äá»˜NG Láº¬P Lá»ŠCH 20 BÃ€I
                        </h3>
                        <p style="color: rgba(255,255,255,0.9); font-size: 14px; margin-bottom: 20px;">
                            ğŸš€ Láº¥y API â†’ AI táº¡o content â†’ Láº­p lá»‹ch cá»‘ Ä‘á»‹nh â†’ Hiá»ƒn thá»‹ table tráº¡ng thÃ¡i
                        </p>
                        
                        <button class="btn" onclick="autoCreateSchedule()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; padding: 18px 40px; font-size: 18px; font-weight: 700; border-radius: 12px; box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                            <i class="fas fa-magic"></i> Báº®T Äáº¦U Tá»° Äá»˜NG
                        </button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <div style="text-align: center; color: white;">
                            <div style="font-size: 20px; margin-bottom: 5px;">ğŸŒ…</div>
                            <div style="font-weight: 600;">SÃ¡ng 8:00</div>
                        </div>
                        <div style="text-align: center; color: white;">
                            <div style="font-size: 20px; margin-bottom: 5px;">ğŸŒ</div>
                            <div style="font-weight: 600;">TrÆ°a 12:00</div>
                        </div>
                        <div style="text-align: center; color: white;">
                            <div style="font-size: 20px; margin-bottom: 5px;">ğŸŒ†</div>
                            <div style="font-weight: 600;">Chiá»u 17:00</div>
                        </div>
                        <div style="text-align: center; color: white;">
                            <div style="font-size: 20px; margin-bottom: 5px;">ğŸŒ™</div>
                            <div style="font-weight: 600;">Tá»‘i 21:00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Schedule Status Table -->
                <div id="scheduleStatusSection" style="display: none; margin-top: 30px;">
                    <div class="card">
                        <h2><i class="fas fa-table"></i> Tráº¡ng thÃ¡i lá»‹ch Ä‘Äƒng 20 bÃ i</h2>
                        <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <div id="scheduleStats" style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <span style="background: #10b981; color: white; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                    <i class="fas fa-check"></i> ThÃ nh cÃ´ng: <span id="successCount">0</span>
                                </span>
                                <span style="background: #f59e0b; color: white; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                    <i class="fas fa-clock"></i> Äang chá»: <span id="pendingCount">0</span>
                                </span>
                                <span style="background: #ef4444; color: white; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                    <i class="fas fa-times"></i> Lá»—i: <span id="errorCount">0</span>
                                </span>
                            </div>
                            <button class="btn btn-secondary" onclick="refreshScheduleTable()" style="margin-left: auto;">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        
                        <div style="overflow-x: auto; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                            <table id="scheduleTable" style="width: 100%; border-collapse: collapse; background: white; font-size: 14px;">
                                <thead>
                                    <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                        <th style="padding: 12px; text-align: center; font-weight: 600; width: 50px;">#</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">TiÃªu Ä‘á»</th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600; width: 80px;">NgÃ y</th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600; width: 100px;">Thá»i gian</th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600; width: 60px;">áº¢nh</th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600; width: 100px;">Tráº¡ng thÃ¡i</th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600; width: 80px;">Thao tÃ¡c</th>
                                    </tr>
                                </thead>
                                <tbody id="scheduleTableBody">
                                    <tr>
                                        <td colspan="7" style="padding: 30px; text-align: center; color: #64748b; font-style: italic;">
                                            Nháº¥n "Báº®T Äáº¦U Tá»° Äá»˜NG" Ä‘á»ƒ táº¡o lá»‹ch Ä‘Äƒng
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="info-box">
                    <i class="fas fa-info-circle"></i> Láº¥y title vÃ  4 hÃ¬nh áº£nh tá»« má»—i bÃ i viáº¿t trong page. Sá»­ dá»¥ng "Xá»­ lÃ½ tá»± Ä‘á»™ng" Ä‘á»ƒ tá»± Ä‘á»™ng láº­p lá»‹ch 20 bÃ i trong 5 ngÃ y.
                </div>
                
                <div id="pageDataList" style="display: none;">
                    <h4 style="margin: 20px 0 15px 0; color: #2d3748;"><i class="fas fa-table"></i> Danh sÃ¡ch bÃ i viáº¿t:</h4>
                    <div style="overflow-x: auto; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                        <table id="articlesTable" style="width: 100%; border-collapse: collapse; background: white;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <th style="padding: 15px; text-align: left; font-weight: 600;">#</th>
                                    <th style="padding: 15px; text-align: left; font-weight: 600;">TiÃªu Ä‘á»</th>
                                    <th style="padding: 15px; text-align: center; font-weight: 600;">HÃ¬nh áº£nh</th>
                                    <th style="padding: 15px; text-align: center; font-weight: 600;">Sá»‘ áº£nh</th>
                                    <th style="padding: 15px; text-align: center; font-weight: 600;">Thao tÃ¡c</th>
                                </tr>
                            </thead>
                            <tbody id="articlesTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>



            <div class="card">
                <h2><i class="fab fa-twitter"></i> ÄÄƒng Tweet</h2>

                <div class="field">
                    <label><i class="fas fa-edit"></i> Ná»™i dung tweet</label>
                    <textarea id="tweetText" rows="5" placeholder="Nháº­p ná»™i dung tweet hoáº·c sao chÃ©p tá»« API á»Ÿ trÃªn..." oninput="updateCharCount()"></textarea>
                    <div id="charCount" class="char-count">0 / 280</div>
                    <div class="info-box">
                        <i class="fas fa-info-circle"></i> Twitter khÃ´ng cho phÃ©p Ä‘Äƒng tweet trÃ¹ng láº·p. HÃ£y thay Ä‘á»•i ná»™i dung hoáº·c thÃªm emoji/thá»i gian Ä‘á»ƒ trÃ¡nh lá»—i.
                    </div>
                </div>

                <div class="field">
                    <label><i class="fas fa-images"></i> URL áº£nh (má»—i dÃ²ng 1 URL, tá»‘i Ä‘a 4)</label>
                    <textarea id="imageUrls" rows="4" placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.jpg&#10;https://example.com/image3.jpg"></textarea>
                    <div class="info-box">
                        <i class="fas fa-camera"></i> DÃ¡n URL áº£nh trá»±c tiáº¿p (JPG, PNG, GIF, WebP)
                    </div>
                </div>

                  

                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="postTweet()" style="flex: 1; min-width: 200px;">
                        <i class="fas fa-paper-plane"></i> ÄÄƒng Tweet Ngay
                    </button>
                    <button class="btn btn-secondary" onclick="toggleSchedule()" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);">
                        <i class="fas fa-clock"></i> Láº­p Lá»‹ch ÄÄƒng
                    </button>
                </div>
                
                <div id="scheduleSection" style="display: none; margin-top: 20px; padding: 20px; background: rgba(248, 250, 252, 0.8); border-radius: 12px;">
                    <h4 style="margin-bottom: 15px; color: #2d3748;"><i class="fas fa-calendar-alt"></i> Láº­p lá»‹ch Ä‘Äƒng tweet</h4>
                    
                    <div class="info-box" style="margin-bottom: 15px;">
                        <i class="fas fa-info-circle"></i> Tweet sáº½ Ä‘Æ°á»£c láº­p lá»‹ch trÃªn server vÃ  tá»± Ä‘á»™ng Ä‘Äƒng vÃ o thá»i gian Ä‘Ã£ chá»n.
                    </div>
                    
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">ğŸ“… NgÃ y Ä‘Äƒng:</label>
                            <input type="date" id="scheduleDate" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">â° Giá» Ä‘Äƒng:</label>
                            <input type="time" id="scheduleTime" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="scheduleTweet()" style="flex: 1;">
                            <i class="fas fa-calendar-plus"></i> XÃ¡c nháº­n láº­p lá»‹ch
                        </button>
                        <button class="btn btn-secondary" onclick="toggleSchedule()" style="flex: 1;">
                            <i class="fas fa-times"></i> Há»§y
                        </button>
                    </div>
                </div>
                
                <button class="btn btn-danger" onclick="clearAll()" style="margin-top: 15px;">
                    <i class="fas fa-trash-alt"></i> XÃ³a táº¥t cáº£
                </button>
                </div>
                <% } %>
        
        <!-- Scheduled Tweets Section -->
        <div class="card">
            <h2><i class="fas fa-calendar-check"></i> Tweet Ä‘Ã£ láº­p lá»‹ch</h2>
            <div class="info-box">
                <i class="fas fa-info-circle"></i> Há»‡ thá»‘ng sá»­ dá»¥ng server-side scheduling Ä‘á»ƒ láº­p lá»‹ch tweet. Tweet sáº½ Ä‘Æ°á»£c Ä‘Äƒng tá»± Ä‘á»™ng vÃ o thá»i gian Ä‘Ã£ chá»n.
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="loadScheduledTweets()">
                    <i class="fas fa-refresh"></i> Táº£i láº¡i danh sÃ¡ch
                </button>
                <button class="btn btn-warning" onclick="debugJobs()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    <i class="fas fa-bug"></i> Debug Jobs
                </button>
                <button class="btn btn-success" onclick="testSchedule()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <i class="fas fa-clock"></i> Test Lá»‹ch (1 phÃºt)
                </button>
            </div>
            <div id="scheduledTweetsList">
                <p style="text-align: center; color: #64748b; font-style: italic;">Nháº¥n "Táº£i láº¡i danh sÃ¡ch" Ä‘á»ƒ xem cÃ¡c tweet Ä‘Ã£ láº­p lá»‹ch</p>
            </div>
        </div>
    </div>

    </div>

    <script>
        function showMessage(msg, type = 'success') {
            const el = document.getElementById('msg');
            el.textContent = msg;
            el.className = `message ${type}`;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 5000);
        }

        function updateCharCount() {
            const text = document.getElementById('tweetText').value;
            const count = text.length;
            const el = document.getElementById('charCount');
            el.textContent = `${count} / 280`;

            if (count > 280) {
                el.className = 'char-count error';
            } else if (count > 250) {
                el.className = 'char-count warning';
            } else {
                el.className = 'char-count';
            }
        }

        let pageArticles = [];

        // Ná»™i dung tiáº¿ng Trung tá»± Ä‘á»™ng
        const chineseContents = [
            "ğŸ”¥ æœ€æ–°çƒ­é—¨å†…å®¹ï¼ç²¾é€‰é«˜è´¨é‡èµ„æºï¼Œæ¯æ—¥æ›´æ–°ä¸é—´æ–­ã€‚ä¸“ä¸šå›¢é˜Ÿç²¾å¿ƒåˆ¶ä½œï¼Œä¸ºæ‚¨å¸¦æ¥æœ€ä½³è§†è§‰ä½“éªŒã€‚ç«‹å³è®¿é—®è·å–æ›´å¤šç²¾å½©å†…å®¹ï¼",
            "âœ¨ ç‹¬å®¶çè—ç‰ˆæœ¬ï¼è¶…æ¸…ç”»è´¨ï¼Œå®Œæ•´æ”¶å½•ï¼Œç»å¯¹å€¼å¾—æ”¶è—ã€‚é™æ—¶å…è´¹åˆ†äº«ï¼Œæœºä¼šéš¾å¾—ä¸å®¹é”™è¿‡ã€‚å¿«æ¥ä½“éªŒé¡¶çº§å“è´¨å†…å®¹ï¼",
            "ï¿½ VIP ä¸“å±èµ„æºï¼ä¼šå‘˜ç‹¬äº«ç‰¹æƒå†…å®¹ï¼Œé«˜ç«¯å®šåˆ¶æœåŠ¡ã€‚ç²¾å“æ¨èï¼Œå“è´¨ä¿è¯ï¼Œæ»¡è¶³æ‚¨çš„æ‰€æœ‰éœ€æ±‚ã€‚ç°åœ¨å°±æ¥æ¢ç´¢æ›´å¤šæƒŠå–œï¼",
            "ğŸ¯ çƒ­é—¨æ¨èç³»åˆ—ï¼ç½‘å‹å¼ºçƒˆæ¨èï¼Œå£ç¢‘çˆ†æ£šçš„ä¼˜è´¨å†…å®¹ã€‚æ¯å¤©éƒ½æœ‰æ–°æƒŠå–œï¼Œè®©æ‚¨äº«å—ä¸ä¸€æ ·çš„ç²¾å½©ä½“éªŒã€‚ä¸è¦é”™è¿‡è¿™ä¸ªæœºä¼šï¼",
            "ğŸŒŸ ç²¾å“æ”¶è—å¿…å¤‡ï¼ç»å…¸æ°¸æ’ï¼Œå€¼å¾—åå¤å“å‘³çš„ä¼˜è´¨èµ„æºã€‚ä¸“ä¸šåˆ¶ä½œå›¢é˜Ÿå€¾åŠ›æ‰“é€ ï¼Œä¸ºæ‚¨å‘ˆç°å®Œç¾è§†è§‰ç››å®´ã€‚",
            "ğŸš€ å…¨ç½‘æœ€ç«å†…å®¹ï¼ç—…æ¯’å¼ä¼ æ’­ï¼Œäººäººéƒ½åœ¨çœ‹çš„çƒ­é—¨èµ„æºã€‚é«˜æ¸…æ— ç ï¼Œå®Œæ•´ç‰ˆæœ¬ï¼Œç»å¯¹è®©æ‚¨æ»¡æ„ã€‚ç«‹å³ç‚¹å‡»æŸ¥çœ‹æ›´å¤šï¼",
            "ğŸ’¯ å“è´¨ä¿è¯ç³»åˆ—ï¼ä¸¥æ ¼ç­›é€‰ï¼Œåªä¸ºç»™æ‚¨æœ€å¥½çš„å†…å®¹ä½“éªŒã€‚æ¯ä¸€éƒ¨éƒ½æ˜¯ç²¾å¿ƒæŒ‘é€‰çš„ä½³ä½œï¼Œä¿è¯è®©æ‚¨ç‰©è¶…æ‰€å€¼ã€‚",
            "ğŸŠ é™æ—¶ç‰¹æƒ åˆ†äº«ï¼å¹³æ—¶æ”¶è´¹å†…å®¹ç°åœ¨å…è´¹å¼€æ”¾ï¼Œæ•°é‡æœ‰é™å…ˆåˆ°å…ˆå¾—ã€‚è¿™æ ·çš„æœºä¼šä¸å¤šï¼Œèµ¶ç´§æŠŠæ¡ä½è¿™æ¬¡æœºä¼šï¼"
        ];

        function clearAll() {
            document.getElementById('tweetText').value = '';
            document.getElementById('imageUrls').value = '';
            document.getElementById('pageDataList').style.display = 'none';
            document.getElementById('articlesTableBody').innerHTML = '';
            pageArticles = [];
            allArticlesContent = [];
            currentUsedIndex = -1;
            updateCharCount();
        }

        async function generateAllArticlesContent() {
            allArticlesContent = [];
            
            for (let i = 0; i < pageArticles.length; i++) {
                const article = pageArticles[i];
                const title = article.title || 'KhÃ´ng cÃ³ tiÃªu Ä‘á»';
                
                try {
                    showMessage(`ğŸ¤– Äang táº¡o ná»™i dung AI cho bÃ i ${i + 1}/${pageArticles.length}: ${title.substring(0, 30)}...`, 'success');
                    
                    // Gá»i AI Ä‘á»ƒ táº¡o ná»™i dung
                    const res = await fetch('/api/ai/generate-content', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title })
                    });
                    const data = await res.json();

                    let aiContent;
                    if (res.ok && data.success) {
                        aiContent = data.content;
                    } else {
                        // Fallback náº¿u AI lá»—i
                        aiContent = getRandomChineseContent();
                    }

                    // LÆ°u ná»™i dung AI
                    allArticlesContent[i] = aiContent;
                    
                    // Cáº­p nháº­t table Ä‘á»ƒ hiá»ƒn thá»‹ tráº¡ng thÃ¡i
                    updateArticleRowStatus(i, 'completed');
                    
                    // Delay giá»¯a cÃ¡c request Ä‘á»ƒ trÃ¡nh rate limit
                    if (i < pageArticles.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                    
                } catch (error) {
                    console.error(`âŒ Lá»—i táº¡o ná»™i dung cho bÃ i ${i + 1}:`, error);
                    allArticlesContent[i] = getRandomChineseContent();
                    updateArticleRowStatus(i, 'error');
                }
            }
            
            // Tá»± Ä‘á»™ng sá»­ dá»¥ng bÃ i viáº¿t Ä‘áº§u tiÃªn
            useArticleWithPreGeneratedContent(0);
            showMessage(`âœ… ÄÃ£ táº¡o xong ná»™i dung AI cho ${pageArticles.length} bÃ i viáº¿t!`, 'success');
        }

        function updateArticleRowStatus(index, status) {
            const row = document.getElementById(`article-row-${index}`);
            if (!row) return;
            
            const statusCell = row.cells[0]; // Cá»™t Ä‘áº§u tiÃªn
            const currentContent = statusCell.innerHTML;
            
            let statusBadge = '';
            if (status === 'completed') {
                statusBadge = '<span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; margin-left: 8px;">âœ“ AI</span>';
            } else if (status === 'error') {
                statusBadge = '<span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; margin-left: 8px;">âš  TPL</span>';
            }
            
            // Thay tháº¿ badge cÅ© báº±ng badge má»›i
            const cleanContent = currentContent.replace(/<span[^>]*>(AUTO|âœ“ AI|âš  TPL)<\/span>/g, '');
            statusCell.innerHTML = cleanContent + statusBadge;
        }

        function useArticleWithPreGeneratedContent(index) {
            const article = pageArticles[index];
            if (!article) return;

            const title = article.title || 'KhÃ´ng cÃ³ tiÃªu Ä‘á»';
            
            // Sá»­ dá»¥ng ná»™i dung AI Ä‘Ã£ táº¡o sáºµn
            const aiContent = allArticlesContent[index] || getRandomChineseContent();
            
            // Äiá»n vÃ o form
            const tweetTextElement = document.getElementById('tweetText');
            const tweetContent = `${title}\n\n${aiContent}`;
            tweetTextElement.value = tweetContent;
            updateCharCount();

            // Äiá»n images
            const imageUrlsElement = document.getElementById('imageUrls');
            if (article.images && article.images.length > 0) {
                const imageUrls = article.images.slice(0, 4).join('\n');
                imageUrlsElement.value = imageUrls;
            } else {
                imageUrlsElement.value = '';
            }

            // Highlight bÃ i viáº¿t Ä‘ang sá»­ dá»¥ng
            if (currentUsedIndex >= 0) {
                const oldRow = document.getElementById(`article-row-${currentUsedIndex}`);
                if (oldRow) oldRow.style.backgroundColor = 'transparent';
            }
            currentUsedIndex = index;
            const currentRow = document.getElementById(`article-row-${index}`);
            if (currentRow) currentRow.style.backgroundColor = '#dcfce7';

            // Scroll to tweet section
            setTimeout(() => {
                const tweetCard = document.querySelector('.card:last-child');
                if (tweetCard) {
                    tweetCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);

            const shortTitle = title.length > 50 ? title.substring(0, 50) + '...' : title;
            const imageCount = article.images ? article.images.length : 0;
            showMessage(`âœ… ÄÃ£ sá»­ dá»¥ng ná»™i dung AI: ${shortTitle} | ${imageCount} áº£nh`, 'success');
        }

        function getRandomChineseContent() {
            return chineseContents[Math.floor(Math.random() * chineseContents.length)];
        }

        function toggleSchedule() {
            const section = document.getElementById('scheduleSection');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                
                // Set default date/time (1 hour from now)
                const now = new Date();
                now.setHours(now.getHours() + 1);
                
                document.getElementById('scheduleDate').value = now.toISOString().split('T')[0];
                document.getElementById('scheduleTime').value = now.toTimeString().slice(0, 5);
            } else {
                section.style.display = 'none';
            }
        }

        async function scheduleTweet() {
            const text = document.getElementById('tweetText').value.trim();
            const imageUrls = document.getElementById('imageUrls').value.trim();
            const scheduleDate = document.getElementById('scheduleDate').value;
            const scheduleTime = document.getElementById('scheduleTime').value;

            if (!text) {
                return showMessage('âš ï¸ Vui lÃ²ng nháº­p ná»™i dung tweet.', 'error');
            }

            if (!scheduleDate || !scheduleTime) {
                return showMessage('âš ï¸ Vui lÃ²ng chá»n ngÃ y vÃ  giá» Ä‘Äƒng.', 'error');
            }

            const scheduledTime = new Date(`${scheduleDate}T${scheduleTime}`);
            if (scheduledTime <= new Date()) {
                return showMessage('âš ï¸ Thá»i gian Ä‘Äƒng pháº£i trong tÆ°Æ¡ng lai.', 'error');
            }

            try {
                showMessage('ğŸ“… Äang láº­p lá»‹ch tweet...', 'success');

                const res = await fetch('/api/twitter/schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        imageUrls: imageUrls,
                        scheduledTime: scheduledTime.toISOString()
                    })
                });
                const data = await res.json();

                if (!res.ok || !data.success) {
                    throw new Error(data.error || 'KhÃ´ng thá»ƒ láº­p lá»‹ch tweet');
                }

                showMessage(`âœ… ${data.message}`, 'success');
                toggleSchedule();
                loadScheduledTweets();

            } catch (err) {
                console.error(err);
                showMessage('âŒ ' + err.message, 'error');
            }
        }

        async function loadScheduledTweets() {
            try {
                const res = await fetch('/api/twitter/scheduled');
                const data = await res.json();

                if (!res.ok || !data.success) {
                    throw new Error('KhÃ´ng thá»ƒ táº£i danh sÃ¡ch tweet');
                }

                displayScheduledTweets(data.tweets);

            } catch (err) {
                console.error(err);
                showMessage('âŒ KhÃ´ng thá»ƒ táº£i danh sÃ¡ch tweet Ä‘Ã£ láº­p lá»‹ch', 'error');
            }
        }

        function displayScheduledTweets(tweets) {
            const container = document.getElementById('scheduledTweetsList');
            
            if (tweets.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #64748b; font-style: italic;">ChÆ°a cÃ³ tweet nÃ o Ä‘Æ°á»£c láº­p lá»‹ch</p>';
                return;
            }

            let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">';
            html += '<thead><tr style="background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%); color: white;">';
            html += '<th style="padding: 12px; text-align: left;">Ná»™i dung</th>';
            html += '<th style="padding: 12px; text-align: center;">áº¢nh</th>';
            html += '<th style="padding: 12px; text-align: center;">Thá»i gian Ä‘Äƒng</th>';
            html += '<th style="padding: 12px; text-align: center;">Thao tÃ¡c</th>';
            html += '</tr></thead><tbody>';

            tweets.forEach(tweet => {
                const scheduleTime = new Date(tweet.scheduledTime);
                const timeStr = scheduleTime.toLocaleString('vi-VN');
                
                html += '<tr style="border-bottom: 1px solid #e2e8f0;">';
                html += `<td style="padding: 12px; max-width: 300px;">${tweet.text}</td>`;
                html += `<td style="padding: 12px; text-align: center;"><span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 8px; font-size: 12px;">${tweet.imageCount}</span></td>`;
                html += `<td style="padding: 12px; text-align: center; font-size: 14px;">${timeStr}</td>`;
                html += `<td style="padding: 12px; text-align: center;">`;
                html += `<button onclick="cancelScheduledTweet(${tweet.id})" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">`;
                html += '<i class="fas fa-times"></i> Há»§y</button></td>';
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        async function cancelScheduledTweet(tweetId) {
            if (!confirm('Báº¡n cÃ³ cháº¯c muá»‘n há»§y lá»‹ch Ä‘Äƒng tweet nÃ y?')) {
                return;
            }

            try {
                const res = await fetch(`/api/twitter/scheduled/${tweetId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();

                if (!res.ok || !data.success) {
                    throw new Error(data.error || 'KhÃ´ng thá»ƒ há»§y lá»‹ch Ä‘Äƒng');
                }

                showMessage('âœ… ÄÃ£ há»§y lá»‹ch Ä‘Äƒng tweet', 'success');
                loadScheduledTweets();

            } catch (err) {
                console.error(err);
                showMessage('âŒ ' + err.message, 'error');
            }
        }

        async function debugJobs() {
            try {
                const res = await fetch('/api/debug/jobs');
                const data = await res.json();

                if (!res.ok || !data.success) {
                    throw new Error('KhÃ´ng thá»ƒ láº¥y thÃ´ng tin debug');
                }

                let debugInfo = `ğŸ› DEBUG THÃ”NG TIN JOBS:\n\n`;
                debugInfo += `â° Thá»i gian hiá»‡n táº¡i: ${data.currentTime}\n`;
                debugInfo += `ğŸ“Š Tá»•ng jobs: ${data.totalJobs}\n`;
                debugInfo += `ğŸ“‹ Tá»•ng tweets: ${data.totalTweets}\n\n`;

                if (data.jobs.length > 0) {
                    debugInfo += `ğŸ“ CHI TIáº¾T JOBS:\n`;
                    data.jobs.forEach((job, index) => {
                        debugInfo += `\n${index + 1}. ID: ${job.tweetId}\n`;
                        debugInfo += `   â° Lá»‹ch: ${job.scheduledTime}\n`;
                        debugInfo += `   ğŸ”§ Cron: ${job.cronFormat}\n`;
                        debugInfo += `   ğŸ“Š Tráº¡ng thÃ¡i: ${job.status}\n`;
                        debugInfo += `   ğŸ“ Ná»™i dung: ${job.content}\n`;
                    });
                } else {
                    debugInfo += `âŒ KhÃ´ng cÃ³ job nÃ o Ä‘ang cháº¡y`;
                }

                alert(debugInfo);
                console.log('Debug Jobs:', data);

            } catch (err) {
                console.error(err);
                showMessage('âŒ Lá»—i debug: ' + err.message, 'error');
            }
        }

        async function testSchedule() {
            if (!confirm('ğŸ§ª Test láº­p lá»‹ch tweet sau 1 phÃºt?\n\nSáº½ táº¡o má»™t tweet test vÃ  Ä‘Äƒng sau 1 phÃºt Ä‘á»ƒ kiá»ƒm tra há»‡ thá»‘ng.')) {
                return;
            }

            try {
                // Táº¡o thá»i gian 1 phÃºt sau
                const testTime = new Date();
                testTime.setMinutes(testTime.getMinutes() + 1);

                const testContent = `ğŸ§ª Test tweet tá»± Ä‘á»™ng - ${new Date().toLocaleString('vi-VN')} 

âœ… Há»‡ thá»‘ng láº­p lá»‹ch hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng!

#Test #AutoPost #Schedule`;

                const res = await fetch('/api/twitter/schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: testContent,
                        imageUrls: '',
                        scheduledTime: testTime.toISOString()
                    })
                });
                const data = await res.json();

                if (!res.ok || !data.success) {
                    throw new Error(data.error || 'KhÃ´ng thá»ƒ táº¡o test schedule');
                }

                showMessage(`âœ… ÄÃ£ táº¡o test tweet! Sáº½ Ä‘Äƒng lÃºc ${testTime.toLocaleString('vi-VN')} (1 phÃºt ná»¯a)`, 'success');
                loadScheduledTweets();

            } catch (err) {
                console.error(err);
                showMessage('âŒ Lá»—i táº¡o test: ' + err.message, 'error');
            }
        }

        let scheduleData = [];

        async function autoCreateSchedule() {
            const baseUrl = document.getElementById('apiBaseUrl').value.trim();
            const page = document.getElementById('apiPage').value;

            if (!baseUrl) {
                return showMessage('âš ï¸ Vui lÃ²ng nháº­p URL API.', 'error');
            }

            // Get tomorrow's date for display
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toLocaleDateString('vi-VN');

            if (!confirm(`ğŸš€ Tá»° Äá»˜NG Láº¬P Lá»ŠCH 20 BÃ€I\n\nğŸ“… Báº¯t Ä‘áº§u: ${tomorrowStr}\nğŸ“‹ Lá»‹ch cá»‘ Ä‘á»‹nh: 8h, 12h, 17h, 21h\nâš¡ 20 bÃ i chia Ä‘á»u 5 ngÃ y (4 bÃ i/ngÃ y)\n\nâœ… XÃ¡c nháº­n vÃ  hiá»ƒn thá»‹ table tráº¡ng thÃ¡i?`)) {
                return;
            }

            try {
                showMessage('ğŸš€ Äang tá»± Ä‘á»™ng táº¡o lá»‹ch vÃ  hiá»ƒn thá»‹ table...', 'success');

                const res = await fetch('/api/auto-schedule-20-fixed', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        apiUrl: baseUrl,
                        page: page 
                    })
                });
                const data = await res.json();

                if (!res.ok || !data.success) {
                    throw new Error(data.error || 'KhÃ´ng thá»ƒ tá»± Ä‘á»™ng láº­p lá»‹ch');
                }

                // Store schedule data
                scheduleData = data.scheduleDetails || [];
                
                // Show table section
                document.getElementById('scheduleStatusSection').style.display = 'block';
                
                // Update table
                updateScheduleTable();
                
                // Show success message
                showMessage(`ğŸ‰ HoÃ n thÃ nh! ÄÃ£ láº­p lá»‹ch ${data.scheduledTweets}/${data.articlesProcessed} bÃ i. Xem table bÃªn dÆ°á»›i.`, 'success');
                
                // Scroll to table
                setTimeout(() => {
                    document.getElementById('scheduleStatusSection').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 500);

            } catch (err) {
                console.error(err);
                showMessage('âŒ ' + err.message, 'error');
            }
        }

        function updateScheduleTable() {
            const tbody = document.getElementById('scheduleTableBody');
            const successCount = scheduleData.filter(item => item.success).length;
            const errorCount = scheduleData.filter(item => !item.success).length;
            const pendingCount = successCount; // All successful items are pending until posted
            
            // Update stats
            document.getElementById('successCount').textContent = successCount;
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('errorCount').textContent = errorCount;
            
            if (scheduleData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="padding: 30px; text-align: center; color: #64748b; font-style: italic;">
                            Nháº¥n "Báº®T Äáº¦U Tá»° Äá»˜NG" Ä‘á»ƒ táº¡o lá»‹ch Ä‘Äƒng
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            scheduleData.forEach((item, index) => {
                const scheduleDate = new Date(item.scheduledTime);
                const dayStr = scheduleDate.toLocaleDateString('vi-VN');
                const timeStr = scheduleDate.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                
                let statusBadge = '';
                let statusColor = '';
                
                if (item.success) {
                    statusBadge = '<i class="fas fa-clock"></i> Äang chá»';
                    statusColor = '#f59e0b';
                } else {
                    statusBadge = '<i class="fas fa-times"></i> Lá»—i';
                    statusColor = '#ef4444';
                }
                
                html += `
                    <tr style="border-bottom: 1px solid #e2e8f0; ${index % 2 === 0 ? 'background: #f8fafc;' : ''}">
                        <td style="padding: 12px; text-align: center; font-weight: 600; color: #667eea;">${item.articleIndex}</td>
                        <td style="padding: 12px;">
                            <div style="font-weight: 500; color: #1a202c; line-height: 1.4; max-width: 300px;">
                                ${item.title}
                            </div>
                        </td>
                        <td style="padding: 12px; text-align: center; font-size: 13px; color: #64748b;">
                            NgÃ y ${item.day}
                        </td>
                        <td style="padding: 12px; text-align: center; font-weight: 500;">
                            <div style="color: #1a202c;">${timeStr}</div>
                            <div style="font-size: 11px; color: #64748b;">${item.timeSlotName}</div>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <span style="background: ${item.imageCount > 0 ? '#10b981' : '#6b7280'}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                ${item.imageCount || 0}
                            </span>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                ${statusBadge}
                            </span>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            ${item.success ? `
                                <button onclick="cancelScheduleItem(${item.tweetId})" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 6px; font-size: 11px; cursor: pointer;" title="Há»§y lá»‹ch">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : `
                                <span style="color: #64748b; font-size: 11px;">N/A</span>
                            `}
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        async function refreshScheduleTable() {
            try {
                showMessage('ğŸ”„ Äang refresh tráº¡ng thÃ¡i...', 'success');
                
                // Get current scheduled tweets from server
                const res = await fetch('/api/twitter/scheduled');
                const data = await res.json();
                
                if (res.ok && data.success) {
                    // Update status based on server data
                    const serverTweets = data.tweets || [];
                    
                    scheduleData.forEach(item => {
                        if (item.success) {
                            const serverTweet = serverTweets.find(t => t.id === item.tweetId);
                            if (!serverTweet) {
                                // Tweet not found in server = might be posted or cancelled
                                item.status = 'completed';
                            }
                        }
                    });
                    
                    updateScheduleTable();
                    showMessage('âœ… ÄÃ£ refresh tráº¡ng thÃ¡i', 'success');
                } else {
                    throw new Error('KhÃ´ng thá»ƒ láº¥y dá»¯ liá»‡u tá»« server');
                }
                
            } catch (err) {
                console.error(err);
                showMessage('âŒ Lá»—i refresh: ' + err.message, 'error');
            }
        }

        async function cancelScheduleItem(tweetId) {
            if (!confirm('Báº¡n cÃ³ cháº¯c muá»‘n há»§y lá»‹ch Ä‘Äƒng tweet nÃ y?')) {
                return;
            }

            try {
                const res = await fetch(`/api/twitter/scheduled/${tweetId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();

                if (!res.ok || !data.success) {
                    throw new Error(data.error || 'KhÃ´ng thá»ƒ há»§y lá»‹ch Ä‘Äƒng');
                }

                // Update local data
                const item = scheduleData.find(s => s.tweetId === tweetId);
                if (item) {
                    item.success = false;
                    item.error = 'ÄÃ£ há»§y';
                }
                
                updateScheduleTable();
                showMessage('âœ… ÄÃ£ há»§y lá»‹ch Ä‘Äƒng tweet', 'success');

            } catch (err) {
                console.error(err);
                showMessage('âŒ ' + err.message, 'error');
            }
        }



        async function fetchPageData() {
            const baseUrl = document.getElementById('apiBaseUrl').value.trim();
            const page = document.getElementById('apiPage').value;

            if (!baseUrl) {
                return showMessage('âš ï¸ Vui lÃ²ng nháº­p URL API.', 'error');
            }

            try {
                showMessage('ğŸ“¡ Äang láº¥y dá»¯ liá»‡u page ' + page + '...', 'success');

                const apiUrl = baseUrl + '&pg=' + page;
                const res = await fetch('/api/fetch-page-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiUrl })
                });
                const data = await res.json();

                if (!res.ok || !data.success) {
                    throw new Error(data.error || 'KhÃ´ng thá»ƒ láº¥y dá»¯ liá»‡u tá»« API');
                }

                pageArticles = data.articles;
                console.log('ğŸ“‹ Dá»¯ liá»‡u pageArticles:', pageArticles);
                displayArticlesTable(data.articles);

                document.getElementById('pageDataList').style.display = 'block';
                showMessage(`âœ… ÄÃ£ láº¥y ${data.articles.length} bÃ i viáº¿t tá»« page ${page}!`, 'success');

                // Tá»± Ä‘á»™ng táº¡o ná»™i dung cho táº¥t cáº£ bÃ i viáº¿t
                if (data.articles.length > 0) {
                    showMessage(`ğŸ¤– Äang tá»± Ä‘á»™ng táº¡o ná»™i dung AI cho ${data.articles.length} bÃ i viáº¿t...`, 'success');
                    setTimeout(() => {
                        generateAllArticlesContent(); // Táº¡o ná»™i dung cho táº¥t cáº£ bÃ i viáº¿t
                    }, 1000);
                }
            } catch (err) {
                console.error(err);
                showMessage('âŒ ' + err.message, 'error');
            }
        }

        async function bulkProcess() {
            const baseUrl = document.getElementById('apiBaseUrl').value.trim();
            const page = document.getElementById('apiPage').value;

            if (!baseUrl) {
                return showMessage('âš ï¸ Vui lÃ²ng nháº­p URL API.', 'error');
            }

            if (!confirm('ğŸš€ Báº¯t Ä‘áº§u xá»­ lÃ½ tá»± Ä‘á»™ng 20 bÃ i?\n\nğŸ“‹ Quy trÃ¬nh:\n1. Láº¥y 20 bÃ i tá»« API\n2. AI táº¡o content cho tá»«ng bÃ i\n3. Láº­p lá»‹ch Ä‘Äƒng 5 ngÃ y (4 bÃ i/ngÃ y)\n\nâ° Thá»i gian: SÃ¡ng 8h, TrÆ°a 12h, Chiá»u 17h, Tá»‘i 21h')) {
                return;
            }

            try {
                showMessage('ğŸš€ Báº¯t Ä‘áº§u xá»­ lÃ½ tá»± Ä‘á»™ng 20 bÃ i...', 'success');

                const res = await fetch('/api/bulk-process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        apiUrl: baseUrl,
                        page: page 
                    })
                });
                const data = await res.json();

                if (!res.ok || !data.success) {
                    throw new Error(data.error || 'KhÃ´ng thá»ƒ xá»­ lÃ½ bulk');
                }

                // Display results
                let resultMessage = `âœ… ${data.message}\n\nğŸ“Š Chi tiáº¿t:\n`;
                resultMessage += `â€¢ BÃ i viáº¿t xá»­ lÃ½: ${data.articlesProcessed}\n`;
                resultMessage += `â€¢ Tweet Ä‘Ã£ láº­p lá»‹ch: ${data.scheduledTweets}\n\n`;
                resultMessage += `ğŸ“… Lá»‹ch Ä‘Äƒng:\n`;
                
                if (data.scheduleDetails && data.scheduleDetails.length > 0) {
                    const groupedByDay = {};
                    data.scheduleDetails.forEach(item => {
                        if (!item.error) {
                            if (!groupedByDay[item.day]) groupedByDay[item.day] = [];
                            groupedByDay[item.day].push(`${item.timeSlot}: ${item.title}`);
                        }
                    });
                    
                    Object.keys(groupedByDay).forEach(day => {
                        resultMessage += `\nNgÃ y ${day}:\n`;
                        groupedByDay[day].forEach(item => {
                            resultMessage += `  â€¢ ${item}\n`;
                        });
                    });
                }

                showMessage(resultMessage, 'success');
                
                // Refresh scheduled tweets list
                setTimeout(() => {
                    loadScheduledTweets();
                }, 2000);

            } catch (err) {
                console.error(err);
                showMessage('âŒ ' + err.message, 'error');
            }
        }

        let currentUsedIndex = -1;
        let allArticlesContent = []; // LÆ°u ná»™i dung AI cho táº¥t cáº£ bÃ i viáº¿t

        function displayArticlesTable(articles) {
            const tbody = document.getElementById('articlesTableBody');
            tbody.innerHTML = '';

            articles.forEach((article, index) => {
                const row = document.createElement('tr');
                row.id = `article-row-${index}`;
                
                // Highlight bÃ i viáº¿t Ä‘áº§u tiÃªn (sáº½ Ä‘Æ°á»£c auto sá»­ dá»¥ng)
                const isFirst = index === 0;
                const baseStyle = isFirst ? 
                    'border-bottom: 1px solid #e2e8f0; transition: background-color 0.2s; background-color: #fef3c7;' :
                    'border-bottom: 1px solid #e2e8f0; transition: background-color 0.2s;';
                
                row.style.cssText = baseStyle;
                row.onmouseover = function() { 
                    if (currentUsedIndex !== index) {
                        this.style.backgroundColor = '#f8fafc'; 
                    }
                };
                row.onmouseout = function() { 
                    if (currentUsedIndex === index) {
                        this.style.backgroundColor = '#dcfce7';
                    } else if (index === 0 && currentUsedIndex === -1) {
                        this.style.backgroundColor = '#fef3c7';
                    } else {
                        this.style.backgroundColor = 'transparent';
                    }
                };

                const title = article.title || 'KhÃ´ng cÃ³ tiÃªu Ä‘á»';
                const imageCount = article.images ? article.images.length : 0;
                
                // Táº¡o preview áº£nh nhá»
                let imagePreview = '';
                if (article.images && article.images.length > 0) {
                    const firstImage = article.images[0];
                    imagePreview = `<img src="${firstImage}" style="width: 60px; height: 40px; object-fit: cover; border-radius: 6px; border: 1px solid #e2e8f0;" onerror="this.style.display='none'">`;
                } else {
                    imagePreview = '<div style="width: 60px; height: 40px; background: #f1f5f9; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #64748b; font-size: 12px;">No img</div>';
                }

                const statusBadge = isFirst ? 
                    '<span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; margin-left: 8px;">AUTO</span>' : '';

                row.innerHTML = `
                    <td style="padding: 15px; font-weight: 600; color: #667eea;">${index + 1}${statusBadge}</td>
                    <td style="padding: 15px; max-width: 300px;">
                        <div style="font-weight: 500; color: #1a202c; line-height: 1.4;">
                            ${title.length > 80 ? title.substring(0, 80) + '...' : title}
                        </div>
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        ${imagePreview}
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        <span style="background: ${imageCount > 0 ? '#10b981' : '#6b7280'}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                            ${imageCount}
                        </span>
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        <button onclick="useArticle(${index})" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            <i class="fas fa-arrow-down"></i> Sá»­ dá»¥ng
                        </button>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        async function useArticle(index) {
            // Náº¿u Ä‘Ã£ cÃ³ ná»™i dung AI sáºµn, dÃ¹ng luÃ´n
            if (allArticlesContent[index]) {
                useArticleWithPreGeneratedContent(index);
                return;
            }
            
            // Náº¿u chÆ°a cÃ³, táº¡o má»›i (fallback)
            console.log('ğŸ”„ Táº¡o ná»™i dung má»›i cho bÃ i viáº¿t index:', index);
            
            const article = pageArticles[index];
            if (!article) {
                console.error('âŒ KhÃ´ng tÃ¬m tháº¥y bÃ i viáº¿t táº¡i index:', index);
                return showMessage('âŒ KhÃ´ng tÃ¬m tháº¥y bÃ i viáº¿t!', 'error');
            }

            const title = article.title || 'KhÃ´ng cÃ³ tiÃªu Ä‘á»';
            showMessage('ğŸ¤– Äang táº¡o ná»™i dung AI theo tiÃªu Ä‘á»...', 'success');

            try {
                const res = await fetch('/api/ai/generate-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title })
                });
                const data = await res.json();

                let chineseContent;
                if (res.ok && data.success) {
                    chineseContent = data.content;
                } else {
                    chineseContent = getRandomChineseContent();
                }

                // LÆ°u ná»™i dung vÃ o cache
                allArticlesContent[index] = chineseContent;
                updateArticleRowStatus(index, 'completed');
                
                // Sá»­ dá»¥ng ná»™i dung vá»«a táº¡o
                useArticleWithPreGeneratedContent(index);

            } catch (error) {
                console.error('âŒ Lá»—i táº¡o ná»™i dung AI:', error);
                allArticlesContent[index] = getRandomChineseContent();
                updateArticleRowStatus(index, 'error');
                useArticleWithPreGeneratedContent(index);
            }
        }

        async function saveKeys() {
            const appKey = document.getElementById('appKey').value.trim();
            const appSecret = document.getElementById('appSecret').value.trim();
            const accessToken = document.getElementById('accessToken').value.trim();
            const accessSecret = document.getElementById('accessSecret').value.trim();

            if (!appKey || !appSecret || !accessToken || !accessSecret) {
                return showMessage('âš ï¸ Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ táº¥t cáº£ cÃ¡c khÃ³a.', 'error');
            }

            try {
                const res = await fetch('/api/twitter/keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ appKey, appSecret, accessToken, accessSecret })
                });
                const data = await res.json();
                if (!res.ok || !data.success) {
                    throw new Error(data.error || 'KhÃ´ng thá»ƒ lÆ°u khÃ³a');
                }
                showMessage('âœ… ÄÃ£ lÆ°u cáº¥u hÃ¬nh thÃ nh cÃ´ng!', 'success');
                setTimeout(() => location.reload(), 1500);
            } catch (err) {
                showMessage('âŒ ' + err.message, 'error');
            }
        }

        async function postTweet() {
            const text = document.getElementById('tweetText').value.trim();
            const imageUrlsText = document.getElementById('imageUrls').value.trim();
            const videoUrl = '';

            if (!text) {
                return showMessage('âš ï¸ Vui lÃ²ng nháº­p ná»™i dung tweet.', 'error');
            }
            if (text.length > 280) {
                return showMessage('âš ï¸ Tweet khÃ´ng Ä‘Æ°á»£c vÆ°á»£t quÃ¡ 280 kÃ½ tá»±.', 'error');
            }



            try {
                const formData = new FormData();
                formData.append('text', text);

                if (imageUrlsText) {
                    const urls = imageUrlsText.split('\n')
                        .map(u => u.trim())
                        .filter(u => u && u.startsWith('http'))
                        .slice(0, 4);

                    if (urls.length > 0) {
                        formData.append('imageUrls', JSON.stringify(urls));
                    }
                }



                showMessage('â³ Äang xá»­ lÃ½ vÃ  Ä‘Äƒng tweet...', 'success');

                const res = await fetch('/api/twitter/post', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (!res.ok || !data.success) {
                    throw new Error(data.error || 'KhÃ´ng thá»ƒ Ä‘Äƒng tweet');
                }

                let msg = 'âœ… ÄÃ£ Ä‘Äƒng tweet thÃ nh cÃ´ng!';
                if (data.imageCount > 0) {
                    msg = `âœ… ÄÃ£ Ä‘Äƒng tweet kÃ¨m ${data.imageCount} áº£nh thÃ nh cÃ´ng!`;
                }
                msg += ` (ID: ${data.tweetId})`;
                showMessage(msg, 'success');

                clearAll();
            } catch (err) {
                console.error(err);
                showMessage('âŒ ' + err.message, 'error');
            }
        }

        // Fetch first article from external API and populate fields
        async function fetchExternalFirst() {
            try {
                showMessage('â³ Äang láº¥y danh sÃ¡ch bÃ i tá»« API...', 'success');
                const perPage = 20;
                const page = parseInt(document.getElementById('apiPage').value || '1', 10) || 1;
                const res = await fetch(`/external/list?perPage=${perPage}&pg=${page}`);
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.error || 'KhÃ´ng thá»ƒ láº¥y danh sÃ¡ch');

                const articles = data.articles || [];
                renderArticleTable(articles);
                renderSchedulePreview(articles, ['08:00','12:00','17:00','21:00']);
                showMessage(`âœ… ÄÃ£ láº¥y ${articles.length} bÃ i`, 'success');
            } catch (err) {
                console.error(err);
                showMessage('âŒ ' + err.message, 'error');
            }
        }

        // Call server to fetch and directly post the first article
        async function postExternalFirst() {
            try {
                showMessage('â³ Äang Ä‘Äƒng bÃ i tá»« API...', 'success');
                const res = await fetch('/external/post-first', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) });
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.error || 'KhÃ´ng thá»ƒ Ä‘Äƒng bÃ i tá»« API');
                let msg = `âœ… ÄÃ£ Ä‘Äƒng bÃ i thÃ nh cÃ´ng (ID: ${data.tweetId})`;
                if (typeof data.imageCount === 'number') msg += ` â€” ${data.imageCount} áº£nh`;
                showMessage(msg, 'success');
            } catch (err) {
                console.error(err);
                showMessage('âŒ ' + err.message, 'error');
            }
        }

        // Schedule 20 posts (4 posts per day: 08:00,12:00,17:00,21:00)
        async function schedule20() {
            try {
                showMessage('â³ Äang yÃªu cáº§u láº­p lá»‹ch 20 bÃ i...', 'success');
                const body = {
                    url: `https://beiyong.slapibf.com/api.php/provide/art/?ac=detail&pg=${parseInt(document.getElementById('apiPage').value||'1',10)}&t=72`,
                    perPage: 20,
                    times: ['08:00','12:00','17:00','21:00']
                };

                // include generate flag from UI
                body.generate = !!document.getElementById('useGenerate').checked;
                const res = await fetch('/external/schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.error || 'KhÃ´ng thá»ƒ láº­p lá»‹ch');

                showMessage(`âœ… ÄÃ£ láº­p lá»‹ch ${data.scheduledCount || 0} bÃ i thÃ nh cÃ´ng`, 'success');
                // Optionally reload schedules or show details
                console.log('Scheduled jobs:', data.jobs);
            } catch (err) {
                console.error(err);
                showMessage('âŒ ' + err.message, 'error');
            }
        }

        // Render fetched articles into a table with preview buttons
        function renderArticleTable(articles) {
            const container = document.getElementById('externalList');
            if (!container) return;
            if (!articles || articles.length === 0) {
                container.innerHTML = '<p>KhÃ´ng cÃ³ bÃ i nÃ o.</p>';
                return;
            }

            let html = '<div style="margin-top:16px; background:#fff; padding:16px; border-radius:12px;">';
            html += '<h3>Danh sÃ¡ch bÃ i (preview)</h3>';
            html += '<table style="width:100%; border-collapse:collapse; margin-top:8px; font-size:14px;">';
            html += '<thead><tr><th style="text-align:left; padding:8px; border-bottom:1px solid #eee">#</th><th style="text-align:left; padding:8px; border-bottom:1px solid #eee">TiÃªu Ä‘á»</th><th style="padding:8px; border-bottom:1px solid #eee">áº¢nh</th><th style="padding:8px; border-bottom:1px solid #eee">Lá»‹ch</th><th style="padding:8px; border-bottom:1px solid #eee">HÃ nh Ä‘á»™ng</th></tr></thead>';
            html += '<tbody>';
            for (let i = 0; i < articles.length; i++) {
                const a = articles[i];
                const imgCount = (a.imageUrls || []).length;
                html += `<tr><td style="padding:8px; border-bottom:1px solid #f3f3f3">${i+1}</td>`;
                html += `<td style="padding:8px; border-bottom:1px solid #f3f3f3">${escapeHtml(a.art_name || '')}${a.generated || a.generatedFull ? ' <span style="color:#059669; font-weight:700;">(AI)</span>' : ''}</td>`;
                html += `<td style="padding:8px; border-bottom:1px solid #f3f3f3">${imgCount} áº£nh</td>`;
                html += `<td style="padding:8px; border-bottom:1px solid #f3f3f3" id="sched-${i}">-</td>`;
                html += `<td style="padding:8px; border-bottom:1px solid #f3f3f3"><button class="btn btn-primary" onclick="showContent(${i})">Xem ná»™i dung</button> <button class="btn btn-secondary" style="margin-left:8px;" onclick="enrichArticle(${i})">Enrich</button> <button class="btn btn-primary" style="margin-left:8px;" onclick="enrichFullArticle(${i})">Content with OpenRouter AI</button></td></tr>`;
            }
            html += '</tbody></table>';
            html += '<div style="display:flex; gap:12px; margin-top:12px;\"><button class="btn btn-primary" onclick="postAll()">Post All (láº­p lá»‹ch)</button><button class="btn btn-secondary" onclick="clearArticleList()">Clear</button></div>';
            html += '</div>';
            container.innerHTML = html;

            // store articles in global for other actions
            window._externalArticles = articles;
        }

        // Enrich a single article by calling server /external/generate
        async function enrichArticle(index) {
            try {
                const articles = window._externalArticles || [];
                const article = articles[index];
                if (!article) return showMessage('BÃ i khÃ´ng tá»“n táº¡i', 'error');
                showMessage('â³ Äang táº¡o ná»™i dung AI...', 'success');
                const res = await fetch('/external/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ article })
                });
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.error || 'KhÃ´ng thá»ƒ táº¡o ná»™i dung');
                const result = data.results && data.results[0];
                if (result && result.extra) {
                    article.generated = result.extra;
                    showMessage('âœ… Táº¡o ná»™i dung AI xong', 'success');
                    showContent(index);
                    renderArticleTable(window._externalArticles);
                } else {
                    throw new Error(result && result.error ? result.error : 'KhÃ´ng cÃ³ káº¿t quáº£');
                }
            } catch (err) {
                console.error(err);
                showMessage('âŒ ' + err.message, 'error');
            }
        }

        // Enrich all articles
        async function enrichAll() {
            try {
                const articles = window._externalArticles || [];
                if (!articles || articles.length === 0) return showMessage('KhÃ´ng cÃ³ bÃ i Ä‘á»ƒ enrich', 'error');
                showMessage('â³ Äang táº¡o ná»™i dung AI cho táº¥t cáº£ bÃ i...', 'success');
                const res = await fetch('/external/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ articles })
                });
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.error || 'KhÃ´ng thá»ƒ táº¡o ná»™i dung');
                const results = data.results || [];
                // Map results back to articles by title
                for (const r of results) {
                    const idx = articles.findIndex(a => a.art_name === r.art_name);
                    if (idx >= 0 && r.extra) {
                        articles[idx].generated = r.extra;
                    }
                }
                window._externalArticles = articles;
                renderArticleTable(articles);
                showMessage('âœ… HoÃ n táº¥t táº¡o ná»™i dung AI cho táº¥t cáº£ bÃ i', 'success');
            } catch (err) {
                console.error(err);
                showMessage('âŒ ' + err.message, 'error');
            }
        }

        // Enrich (generate full title+content) for single article
        async function enrichFullArticle(index) {
            try {
                const articles = window._externalArticles || [];
                const article = articles[index];
                if (!article) return showMessage('BÃ i khÃ´ng tá»“n táº¡i', 'error');
                showMessage('â³ Äang táº¡o ná»™i dung Ä‘áº§y Ä‘á»§ báº±ng AI...', 'success');
                const res = await fetch('/external/generate-full', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ article })
                });
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.error || 'KhÃ´ng thá»ƒ táº¡o ná»™i dung');
                const result = data.results && data.results[0];
                if (result && !result.error) {
                    article.art_name = result.new_title || article.art_name;
                    article.art_content = result.full_content || article.art_content;
                    article.generatedFull = true;
                    window._externalArticles = articles;
                    renderArticleTable(articles);
                    showContent(index);
                    showMessage('âœ… ÄÃ£ cáº­p nháº­t tiÃªu Ä‘á» vÃ  ná»™i dung báº±ng AI', 'success');
                } else {
                    throw new Error(result && result.error ? result.error : 'KhÃ´ng cÃ³ káº¿t quáº£');
                }
            } catch (err) {
                console.error(err);
                showMessage('âŒ ' + err.message, 'error');
            }
        }

        // Enrich full for all articles
        async function enrichAllFull() {
            try {
                const articles = window._externalArticles || [];
                if (!articles || articles.length === 0) return showMessage('KhÃ´ng cÃ³ bÃ i Ä‘á»ƒ enrich', 'error');
                showMessage('â³ Äang táº¡o ná»™i dung Ä‘áº§y Ä‘á»§ báº±ng AI cho táº¥t cáº£ bÃ i...', 'success');
                const res = await fetch('/external/generate-full', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ articles })
                });
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.error || 'KhÃ´ng thá»ƒ táº¡o ná»™i dung');
                const results = data.results || [];
                for (const r of results) {
                    const idx = articles.findIndex(a => a.art_name === r.art_name || a.art_name === r.art_name);
                    if (idx >= 0 && !r.error) {
                        articles[idx].art_name = r.new_title || articles[idx].art_name;
                        articles[idx].art_content = r.full_content || articles[idx].art_content;
                        articles[idx].generatedFull = true;
                    }
                }
                window._externalArticles = articles;
                renderArticleTable(articles);
                showMessage('âœ… HoÃ n táº¥t táº¡o ná»™i dung Ä‘áº§y Ä‘á»§ cho táº¥t cáº£ bÃ i', 'success');
            } catch (err) {
                console.error(err);
                showMessage('âŒ ' + err.message, 'error');
            }
        }

        function clearArticleList() {
            const container = document.getElementById('externalList');
            if (container) container.innerHTML = '';
            const preview = document.getElementById('contentPreview');
            if (preview) preview.innerHTML = '';
            window._externalArticles = [];
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/[&<>\"']/g, function (c) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'})[c]; });
        }

        function showContent(index) {
            const articles = window._externalArticles || [];
            const a = articles[index];
            const preview = document.getElementById('contentPreview');
            if (!a || !preview) return;
            preview.innerHTML = `<div style="background:#fff; padding:12px; border-radius:12px; margin-top:12px;\"><h4>${escapeHtml(a.art_name || '')}</h4><div style="margin-top:8px;">${a.art_content || ''}</div></div>`;
            window.scrollTo({ top: preview.offsetTop - 20, behavior: 'smooth' });
        }

        // Compute schedule preview and fill schedule column
        function renderSchedulePreview(articles, times, startDate = new Date()) {
            const slotsPerDay = times.length;
            for (let i = 0; i < articles.length; i++) {
                const timeIndex = i % slotsPerDay;
                const dayOffset = Math.floor(i / slotsPerDay);
                const [h, m] = times[timeIndex].split(':').map(Number);
                const scheduled = new Date(startDate);
                scheduled.setDate(scheduled.getDate() + dayOffset);
                scheduled.setHours(h, m, 0, 0);
                while (scheduled.getTime() <= Date.now()) scheduled.setDate(scheduled.getDate() + 1);
                const el = document.getElementById(`sched-${i}`);
                if (el) el.textContent = scheduled.toLocaleString();
            }
        }

        // Post all: send articles to server to schedule (uses server-side scheduler)
        async function postAll() {
            try {
                const articles = window._externalArticles || [];
                if (!articles || articles.length === 0) return showMessage('KhÃ´ng cÃ³ bÃ i Ä‘á»ƒ post', 'error');
                showMessage('â³ Äang yÃªu cáº§u láº­p lá»‹ch cho táº¥t cáº£ bÃ i...', 'success');
                // include page info in request for traceability
                const page = parseInt(document.getElementById('apiPage').value || '1', 10) || 1;
                const res = await fetch('/external/schedule-articles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ articles, times: ['08:00','12:00','17:00','21:00'], page, generate: !!document.getElementById('useGenerate').checked })
                });
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.error || 'KhÃ´ng thá»ƒ láº­p lá»‹ch');
                showMessage(`âœ… ÄÃ£ láº­p lá»‹ch ${data.scheduledCount || 0} bÃ i`, 'success');
            } catch (err) {
                console.error(err);
                showMessage('âŒ ' + err.message, 'error');
            }
        }
    </script>
</body>

</html>