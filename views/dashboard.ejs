<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Twitter Auto Post</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #000000;
            --text-secondary: #6c757d;
            --border-color: #e9ecef;
            --accent-color: #000000;
            --hover-bg: #f8f9fa;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --sidebar-width: 250px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Dashboard Layout */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            padding: 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-header h2 {
            color: var(--text-primary);
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-item {
            display: block;
            padding: 12px 20px;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-item:hover {
            background: var(--hover-bg);
        }

        .nav-item.active {
            background: var(--accent-color);
            color: white;
        }

        .nav-item i {
            width: 20px;
            margin-right: 12px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 24px;
        }

        .content-header {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        .content-header h1 {
            color: var(--text-primary);
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .content-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Content Sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .stat-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .stat-card-title {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .stat-card-icon {
            width: 40px;
            height: 40px;
            background: var(--bg-secondary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-color);
        }

        .stat-card-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .stat-card-change {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Card */
        .card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        .card h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-btn {
                display: block;
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 1000;
                background: var(--bg-primary);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 12px;
                cursor: pointer;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .mobile-menu-btn {
            display: none;
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2><i class="fab fa-twitter"></i> Twitter Auto</h2>
            </div>
            <nav class="sidebar-nav">
                <button class="nav-item active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
                <button class="nav-item" onclick="showSection('post')">
                    <i class="fas fa-edit"></i> Post
                </button>
                <button class="nav-item" onclick="showSection('schedule')">
                    <i class="fas fa-calendar"></i> L·ªãch ƒëƒÉng
                </button>
                <button class="nav-item" onclick="showSection('tweets')">
                    <i class="fas fa-list"></i> Danh s√°ch Tweet
                </button>
                <button class="nav-item" onclick="showSection('settings')">
                    <i class="fas fa-cog"></i> C√†i ƒë·∫∑t
                </button>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <div class="content-header">
                    <h1>Dashboard</h1>
                    <p>T·ªïng quan h·ªá th·ªëng Twitter Auto Post</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-card-title">T·ªïng Tweet</span>
                            <div class="stat-card-icon">
                                <i class="fab fa-twitter"></i>
                            </div>
                        </div>
                        <div class="stat-card-value" id="totalTweets">0</div>
                        <div class="stat-card-change">T·∫•t c·∫£ th·ªùi gian</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-card-title">Tweet h√¥m nay</span>
                            <div class="stat-card-icon">
                                <i class="fas fa-calendar-day"></i>
                            </div>
                        </div>
                        <div class="stat-card-value" id="todayTweets">0</div>
                        <div class="stat-card-change">Trong 24h qua</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-card-title">L·ªãch ƒëƒÉng</span>
                            <div class="stat-card-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <div class="stat-card-value" id="scheduledTweets">0</div>
                        <div class="stat-card-change">ƒêang ch·ªù ƒëƒÉng</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-card-title">B√†i vi·∫øt API</span>
                            <div class="stat-card-icon">
                                <i class="fas fa-database"></i>
                            </div>
                        </div>
                        <div class="stat-card-value" id="apiArticles">0</div>
                        <div class="stat-card-change">ƒê√£ x·ª≠ l√Ω</div>
                    </div>
                </div>

                <!-- Twitter Account Stats -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-card-title">Followers</span>
                            <div class="stat-card-icon">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="stat-card-value" id="followersCount">-</div>
                        <div class="stat-card-change">Twitter Account</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-card-title">Following</span>
                            <div class="stat-card-icon">
                                <i class="fas fa-user-plus"></i>
                            </div>
                        </div>
                        <div class="stat-card-value" id="followingCount">-</div>
                        <div class="stat-card-change">ƒêang theo d√µi</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-card-title">Tweets</span>
                            <div class="stat-card-icon">
                                <i class="fab fa-twitter"></i>
                            </div>
                        </div>
                        <div class="stat-card-value" id="tweetCount">-</div>
                        <div class="stat-card-change">T·ªïng tweet</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-card-title">Account</span>
                            <div class="stat-card-icon">
                                <i class="fas fa-at"></i>
                            </div>
                        </div>
                        <div class="stat-card-value" id="username" style="font-size: 18px;">-</div>
                        <div class="stat-card-change">
                            Username 
                            <button onclick="loadTwitterAccountInfo()" style="margin-left: 8px; background: none; border: 1px solid var(--border-color); border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 10px;" title="Refresh th√¥ng tin account">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2><i class="fas fa-chart-line"></i> Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h2>
                    <div id="recentActivity">
                        <p style="color: var(--text-secondary); text-align: center; padding: 40px;">
                            Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o
                        </p>
                    </div>
                </div>
            </div>

            <!-- Post Section -->
            <div id="post" class="content-section">
                <div class="content-header">
                    <h1>ƒêƒÉng Tweet</h1>
                    <p>Qu·∫£n l√Ω v√† ƒëƒÉng tweet t·ª± ƒë·ªông</p>
                </div>
                
                <!-- Post content will be loaded here -->
                <div id="postContent">
                    <p style="text-align: center; color: var(--text-secondary); padding: 40px;">
                        ƒêang t·∫£i n·ªôi dung...
                    </p>
                </div>
            </div>

            <!-- Schedule Section -->
            <div id="schedule" class="content-section">
                <div class="content-header">
                    <h1>L·ªãch ƒëƒÉng</h1>
                    <p>Qu·∫£n l√Ω c√°c tweet ƒë√£ l·∫≠p l·ªãch</p>
                </div>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2><i class="fas fa-list"></i> Tweet ƒë√£ l·∫≠p l·ªãch</h2>
                        <button onclick="createTestScheduledTweet()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            <i class="fas fa-plus"></i> T·∫°o test tweet
                        </button>
                    </div>
                    <div id="scheduledList">
                        <p style="color: var(--text-secondary); text-align: center; padding: 40px;">
                            Ch∆∞a c√≥ tweet n√†o ƒë∆∞·ª£c l·∫≠p l·ªãch
                        </p>
                    </div>
                </div>
            </div>

            <!-- Tweets List Section -->
            <div id="tweets" class="content-section">
                <div class="content-header">
                    <h1>Danh s√°ch Tweet</h1>
                    <p>Qu·∫£n l√Ω c√°c tweet ƒë√£ ƒëƒÉng v√† ƒëang ch·ªù ƒëƒÉng</p>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <!-- Posted Tweets -->
                    <div class="card">
                        <h2><i class="fab fa-twitter"></i> Tweet ƒë√£ ƒëƒÉng</h2>
                        <div id="postedTweetsStats" style="margin-bottom: 15px; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>T·ªïng s·ªë: <strong id="postedTotal">0</strong></span>
                                <span>Th√†nh c√¥ng: <strong id="postedSuccess">0</strong></span>
                                <span>H√¥m nay: <strong id="postedToday">0</strong></span>
                            </div>
                        </div>
                        <div id="postedTweetsList" style="max-height: 400px; overflow-y: auto;">
                            <p style="color: var(--text-secondary); text-align: center; padding: 40px;">
                                ƒêang t·∫£i danh s√°ch tweet ƒë√£ ƒëƒÉng...
                            </p>
                        </div>
                    </div>

                    <!-- Scheduled Tweets -->
                    <div class="card">
                        <h2><i class="fas fa-clock"></i> Tweet ƒëang ch·ªù</h2>
                        <div id="scheduledTweetsStats" style="margin-bottom: 15px; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>T·ªïng s·ªë: <strong id="scheduledTotal">0</strong></span>
                                <span>ƒêang ch·ªù: <strong id="scheduledPending">0</strong></span>
                                <span>S·∫Øp t·ªõi: <strong id="scheduledUpcoming">0</strong></span>
                            </div>
                        </div>
                        <div id="scheduledTweetsList" style="max-height: 400px; overflow-y: auto;">
                            <p style="color: var(--text-secondary); text-align: center; padding: 40px;">
                                ƒêang t·∫£i danh s√°ch tweet ƒëang ch·ªù...
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="content-section">
                <div class="content-header">
                    <h1>C√†i ƒë·∫∑t</h1>
                    <p>C·∫•u h√¨nh h·ªá th·ªëng v√† API keys</p>
                </div>
                
                <div class="card">
                    <h2><i class="fas fa-key"></i> Twitter API Keys</h2>
                    <div id="settingsContent">
                        <p style="text-align: center; color: var(--text-secondary); padding: 40px;">
                            ƒêang t·∫£i c√†i ƒë·∫∑t...
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Navigation
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Add active class to clicked nav item
            event.target.classList.add('active');
            
            // Load content based on section
            loadSectionContent(sectionId);
            
            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function loadSectionContent(sectionId) {
            switch(sectionId) {
                case 'dashboard':
                    loadDashboardStats();
                    break;
                case 'post':
                    loadPostContent();
                    break;
                case 'schedule':
                    loadScheduledTweets();
                    break;
                case 'tweets':
                    loadTweetsList();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        async function loadDashboardStats() {
            try {
                // Load dashboard statistics
                const response = await fetch('/api/dashboard/stats');
                if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById('totalTweets').textContent = data.totalTweets || 0;
                    document.getElementById('todayTweets').textContent = data.todayTweets || 0;
                    document.getElementById('scheduledTweets').textContent = data.scheduledTweets || 0;
                    document.getElementById('apiArticles').textContent = data.apiArticles || 0;
                    
                    // Load recent activity
                    if (data.recentActivity && data.recentActivity.length > 0) {
                        let activityHtml = '';
                        data.recentActivity.forEach(activity => {
                            activityHtml += `
                                <div style="padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 12px;">
                                    <i class="${activity.icon}" style="color: var(--accent-color);"></i>
                                    <div>
                                        <div style="font-weight: 500;">${activity.title}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">${activity.time}</div>
                                    </div>
                                </div>
                            `;
                        });
                        document.getElementById('recentActivity').innerHTML = activityHtml;
                    }
                }
                
                // Load Twitter account info
                loadTwitterAccountInfo();
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        async function loadTwitterAccountInfo() {
            try {
                let response = await fetch('/api/twitter/account-info');
                let data = null;
                
                if (response.ok) {
                    data = await response.json();
                }
                
                // If rate limited or failed, try test endpoint
                if (!data || !data.success || data.rateLimited) {
                    console.log('Trying test endpoint due to rate limit or error');
                    response = await fetch('/api/test/twitter-account');
                    if (response.ok) {
                        data = await response.json();
                    }
                }
                
                if (data && data.success) {
                    document.getElementById('followersCount').textContent = formatNumber(data.followers);
                    document.getElementById('followingCount').textContent = formatNumber(data.following);
                    document.getElementById('tweetCount').textContent = formatNumber(data.tweets);
                    document.getElementById('username').textContent = '@' + data.username;
                    
                    // Show indicator if using cached or mock data
                    if (data.cached || data.mock) {
                        const indicator = data.cached ? ' (cached)' : ' (demo)';
                        document.getElementById('username').textContent += indicator;
                    }
                } else {
                    // Show error state
                    document.getElementById('followersCount').textContent = '-';
                    document.getElementById('followingCount').textContent = '-';
                    document.getElementById('tweetCount').textContent = '-';
                    document.getElementById('username').textContent = 'Ch∆∞a k·∫øt n·ªëi';
                }
            } catch (error) {
                console.error('Error loading Twitter account info:', error);
                // Show error state
                document.getElementById('followersCount').textContent = 'L·ªói';
                document.getElementById('followingCount').textContent = 'L·ªói';
                document.getElementById('tweetCount').textContent = 'L·ªói';
                document.getElementById('username').textContent = 'L·ªói k·∫øt n·ªëi';
            }
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        async function loadPostContent() {
            try {
                const response = await fetch('/dashboard/post-content');
                if (response.ok) {
                    const html = await response.text();
                    document.getElementById('postContent').innerHTML = html;
                    
                    // Execute scripts after loading content
                    executePostScripts();
                }
            } catch (error) {
                console.error('Error loading post content:', error);
                document.getElementById('postContent').innerHTML = '<p style="color: red; text-align: center;">L·ªói t·∫£i n·ªôi dung</p>';
            }
        }

        // Execute scripts for post section
        function executePostScripts() {
            // No scripts to execute since all JavaScript is now in dashboard.ejs
            // Just ensure the message element is available
            if (!document.getElementById('msg')) {
                console.log('Message element not found in post content');
            }
        }

        async function loadScheduledTweets() {
            try {
                const response = await fetch('/api/twitter/scheduled');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.tweets && data.tweets.length > 0) {
                        let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';
                        html += '<thead><tr style="background: var(--bg-secondary);"><th style="padding: 12px; text-align: left;">N·ªôi dung</th><th style="padding: 12px; text-align: center;">Th·ªùi gian</th><th style="padding: 12px; text-align: center;">Thao t√°c</th></tr></thead><tbody>';
                        
                        data.tweets.forEach(tweet => {
                            const time = new Date(tweet.scheduledTime).toLocaleString('vi-VN');
                            html += `
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td style="padding: 12px; max-width: 300px;">${tweet.text.substring(0, 100)}...</td>
                                    <td style="padding: 12px; text-align: center;">${time}</td>
                                    <td style="padding: 12px; text-align: center;">
                                        <button onclick="cancelTweet(${tweet.id})" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">H·ªßy</button>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        html += '</tbody></table></div>';
                        document.getElementById('scheduledList').innerHTML = html;
                    }
                }
            } catch (error) {
                console.error('Error loading scheduled tweets:', error);
            }
        }

        async function loadTweetsList() {
            try {
                // Load posted tweets
                const postedResponse = await fetch('/api/tweets/posted?limit=50');
                if (postedResponse.ok) {
                    const postedData = await postedResponse.json();
                    if (postedData.success) {
                        // Update stats
                        document.getElementById('postedTotal').textContent = postedData.stats.total;
                        document.getElementById('postedSuccess').textContent = postedData.stats.success;
                        document.getElementById('postedToday').textContent = postedData.stats.today;
                        
                        // Update list
                        if (postedData.tweets && postedData.tweets.length > 0) {
                            let html = '';
                            postedData.tweets.forEach(tweet => {
                                const statusColor = tweet.status === 'SUCCESS' ? '#28a745' : '#dc3545';
                                const statusText = tweet.status === 'SUCCESS' ? 'Th√†nh c√¥ng' : 'L·ªói';
                                html += `
                                    <div style="padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 500; margin-bottom: 4px;">${tweet.content}</div>
                                            <div style="font-size: 12px; color: var(--text-secondary);">
                                                ${tweet.timeFormatted} ‚Ä¢ ${tweet.imageCount} ·∫£nh
                                            </div>
                                        </div>
                                        <div style="margin-left: 12px;">
                                            <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                                ${statusText}
                                            </span>
                                        </div>
                                    </div>
                                `;
                            });
                            document.getElementById('postedTweetsList').innerHTML = html;
                        } else {
                            document.getElementById('postedTweetsList').innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">Ch∆∞a c√≥ tweet n√†o ƒë∆∞·ª£c ƒëƒÉng</p>';
                        }
                    }
                }

                // Load scheduled tweets
                const scheduledResponse = await fetch('/api/tweets/scheduled');
                if (scheduledResponse.ok) {
                    const scheduledData = await scheduledResponse.json();
                    if (scheduledData.success) {
                        // Update stats
                        document.getElementById('scheduledTotal').textContent = scheduledData.stats.total;
                        document.getElementById('scheduledPending').textContent = scheduledData.stats.pending;
                        document.getElementById('scheduledUpcoming').textContent = scheduledData.stats.upcoming;
                        
                        // Update list
                        if (scheduledData.tweets && scheduledData.tweets.length > 0) {
                            let html = '';
                            scheduledData.tweets.forEach(tweet => {
                                const statusColor = tweet.status === 'PENDING' ? '#ffc107' : '#6c757d';
                                const statusText = tweet.status === 'PENDING' ? 'ƒêang ch·ªù' : tweet.status;
                                html += `
                                    <div style="padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 500; margin-bottom: 4px;">${tweet.content}</div>
                                            <div style="font-size: 12px; color: var(--text-secondary);">
                                                ${tweet.scheduledTimeFormatted} ‚Ä¢ ${tweet.imageCount} ·∫£nh
                                            </div>
                                        </div>
                                        <div style="margin-left: 12px; display: flex; align-items: center; gap: 8px;">
                                            <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                                ${statusText}
                                            </span>
                                            <button onclick="cancelTweet(${tweet.id})" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                                H·ªßy
                                            </button>
                                        </div>
                                    </div>
                                `;
                            });
                            document.getElementById('scheduledTweetsList').innerHTML = html;
                        } else {
                            document.getElementById('scheduledTweetsList').innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">Ch∆∞a c√≥ tweet n√†o ƒë∆∞·ª£c l·∫≠p l·ªãch</p>';
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading tweets list:', error);
            }
        }

        async function loadSettings() {
            try {
                const response = await fetch('/dashboard/settings-content');
                if (response.ok) {
                    const html = await response.text();
                    document.getElementById('settingsContent').innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                document.getElementById('settingsContent').innerHTML = '<p style="color: red; text-align: center;">L·ªói t·∫£i c√†i ƒë·∫∑t</p>';
            }
        }

        async function cancelTweet(tweetId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy tweet n√†y?')) return;
            
            try {
                const response = await fetch(`/api/twitter/scheduled/${tweetId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Show success message
                    if (result.success) {
                        showMessage('‚úÖ ƒê√£ h·ªßy tweet th√†nh c√¥ng!', 'success');
                    }
                    
                    // Update all relevant sections
                    loadScheduledTweets(); // Reload schedule section
                    loadDashboardStats(); // Update dashboard stats
                    
                    // Update tweets list section if it's currently active
                    const tweetsSection = document.getElementById('tweets');
                    if (tweetsSection && tweetsSection.classList.contains('active')) {
                        loadTweetsList();
                    }
                } else {
                    const result = await response.json();
                    showMessage('‚ùå L·ªói: ' + (result.error || 'Kh√¥ng th·ªÉ h·ªßy tweet'), 'error');
                }
            } catch (error) {
                console.error('Error canceling tweet:', error);
                showMessage('‚ùå L·ªói k·∫øt n·ªëi khi h·ªßy tweet', 'error');
            }
        }

        // Helper function to show messages
        function showMessage(message, type = 'info') {
            // Create message element
            const messageEl = document.createElement('div');
            messageEl.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
            `;
            messageEl.textContent = message;
            
            document.body.appendChild(messageEl);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.parentNode.removeChild(messageEl);
                }
            }, 3000);
        }

        // Create test scheduled tweet
        async function createTestScheduledTweet() {
            try {
                showMessage('üîÑ ƒêang t·∫°o test tweet...', 'info');
                
                const response = await fetch('/api/test/schedule-tweet', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showMessage(result.message, 'success');
                        
                        // Update all relevant sections
                        loadScheduledTweets();
                        loadDashboardStats();
                        
                        // Update tweets list if active
                        const tweetsSection = document.getElementById('tweets');
                        if (tweetsSection && tweetsSection.classList.contains('active')) {
                            loadTweetsList();
                        }
                    } else {
                        showMessage('‚ùå L·ªói: ' + result.error, 'error');
                    }
                } else {
                    showMessage('‚ùå L·ªói k·∫øt n·ªëi khi t·∫°o test tweet', 'error');
                }
            } catch (error) {
                console.error('Error creating test tweet:', error);
                showMessage('‚ùå L·ªói k·∫øt n·ªëi', 'error');
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardStats();
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
        });

        // ===== POST SECTION JAVASCRIPT =====
        // Global variables for post section
        let pageArticles = [];
        let currentUsedIndex = -1;
        let allArticlesContent = [];

        // N·ªôi dung ti·∫øng Trung t·ª± ƒë·ªông
        const chineseContents = [
            "üî• ÊúÄÊñ∞ÁÉ≠Èó®ÂÜÖÂÆπÔºÅÁ≤æÈÄâÈ´òË¥®ÈáèËµÑÊ∫ê\n\nüéØ Á´ãÂç≥ËÆøÈóÆ 6868.run\n\n#ÁÉ≠Èó® #Á≤æÈÄâ #È´òË¥®Èáè",
            "‚ú® Áã¨ÂÆ∂ÁèçËóèÁâàÊú¨ÔºÅË∂ÖÊ∏ÖÁîªË¥®ÂÆåÊï¥Êî∂ÂΩï\n\nüéØ ‰ΩìÈ™åÈ°∂Á∫ßÂìÅË¥® 6868.run\n\n#Áã¨ÂÆ∂ #ÁèçËóè #Ë∂ÖÊ∏Ö",
            "üíé VIP‰∏ìÂ±ûËµÑÊ∫êÔºÅ‰ºöÂëòÁã¨‰∫´ÁâπÊùÉÂÜÖÂÆπ\n\nüéØ Êé¢Á¥¢Êõ¥Â§öÊÉäÂñú 6868.run\n\n#VIP #‰∏ìÂ±û #ÁâπÊùÉ",
            "üéØ ÁÉ≠Èó®Êé®ËçêÁ≥ªÂàóÔºÅÁΩëÂèãÂº∫ÁÉàÊé®Ëçê\n\nüéØ ‰∫´ÂèóÁ≤æÂΩ©‰ΩìÈ™å 6868.run\n\n#Êé®Ëçê #Âè£Á¢ë #‰ºòË¥®",
            "üåü Á≤æÂìÅÊî∂ËóèÂøÖÂ§áÔºÅÁªèÂÖ∏Ê∞∏ÊÅíÂìÅË¥®\n\nüéØ ÂèëÁé∞Êõ¥Â§öÁ≤æÂìÅ 6868.run\n\n#Á≤æÂìÅ #ÁªèÂÖ∏ #Ê∞∏ÊÅí",
            "üöÄ ÂÖ®ÁΩëÊúÄÁÅ´ÂÜÖÂÆπÔºÅÁóÖÊØíÂºè‰º†Êí≠\n\nüéØ Á´ãÂç≥Êü•ÁúãÊõ¥Â§ö 6868.run\n\n#ÂÖ®ÁΩëÊúÄÁÅ´ #ÁóÖÊØí‰º†Êí≠ #ÁÉ≠Èó®",
            "üíØ ÂìÅË¥®‰øùËØÅÁ≥ªÂàóÔºÅ‰∏•Ê†ºÁ≠õÈÄâ‰Ω≥‰Ωú\n\nüéØ ‰ΩìÈ™åÊúÄ‰Ω≥ÂÜÖÂÆπ 6868.run\n\n#ÂìÅË¥®‰øùËØÅ #Á≤æÈÄâ #‰Ω≥‰Ωú",
            "üéä ÈôêÊó∂ÁâπÊÉ†ÂàÜ‰∫´ÔºÅÂÖçË¥πÂºÄÊîæ\n\nüéØ ÊääÊè°Êú∫‰ºöËÆøÈóÆ 6868.run\n\n#ÈôêÊó∂ÁâπÊÉ† #ÂÖçË¥π #Êú∫‰ºö"
        ];

        function getRandomChineseContent() {
            return chineseContents[Math.floor(Math.random() * chineseContents.length)];
        }

        function showPostMessage(msg, type = 'success') {
            const el = document.getElementById('msg');
            if (!el) {
                console.log('Message element not found, using console:', msg);
                return;
            }
            
            el.textContent = msg;
            el.style.display = 'block';
            
            if (type === 'success') {
                el.style.background = '#d4edda';
                el.style.color = '#155724';
                el.style.borderLeftColor = '#28a745';
            } else {
                el.style.background = '#f8d7da';
                el.style.color = '#721c24';
                el.style.borderLeftColor = '#dc3545';
            }
            
            setTimeout(() => { el.style.display = 'none'; }, 5000);
        }

        function updateCharCount() {
            const text = document.getElementById('tweetText');
            const el = document.getElementById('charCount');
            if (!text || !el) return;
            
            const count = text.value.length;
            el.textContent = `${count} / 280`;

            if (count > 280) {
                el.style.color = '#dc3545';
            } else if (count > 250) {
                el.style.color = '#ffc107';
            } else {
                el.style.color = 'var(--text-secondary)';
            }
        }

        function previewImages() {
            const imageUrls = document.getElementById('imageUrls');
            const previewArea = document.getElementById('imagePreviewArea');
            const previewContainer = document.getElementById('imagePreviewContainer');
            
            if (!imageUrls || !previewArea || !previewContainer) return;
            
            const urls = imageUrls.value.split('\n')
                .map(u => u.trim())
                .filter(u => u && u.startsWith('http'))
                .slice(0, 4);
            
            if (urls.length === 0) {
                previewArea.style.display = 'none';
                return;
            }
            
            previewArea.style.display = 'block';
            previewContainer.innerHTML = '';
            
            urls.forEach((url, index) => {
                const imgContainer = document.createElement('div');
                imgContainer.style.cssText = 'position: relative; display: inline-block;';
                
                const img = document.createElement('img');
                img.src = url;
                img.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 4px; border: 2px solid var(--border-color);';
                img.title = `·∫¢nh ${index + 1}: ${url}`;
                
                const label = document.createElement('div');
                label.textContent = index + 1;
                label.style.cssText = 'position: absolute; top: -8px; right: -8px; background: var(--accent-color); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold;';
                
                img.onerror = function() {
                    imgContainer.innerHTML = `
                        <div style="width: 80px; height: 80px; background: #f8d7da; border: 2px solid #dc3545; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #721c24; font-size: 10px; text-align: center;">
                            L·ªói t·∫£i ·∫£nh ${index + 1}
                        </div>
                    `;
                };
                
                imgContainer.appendChild(img);
                imgContainer.appendChild(label);
                previewContainer.appendChild(imgContainer);
            });
            
            // Show count
            const countInfo = document.createElement('div');
            countInfo.style.cssText = 'width: 100%; text-align: center; color: var(--text-secondary); font-size: 12px; margin-top: 8px;';
            countInfo.textContent = `${urls.length}/4 ·∫£nh s·∫Ω ƒë∆∞·ª£c ƒëƒÉng l√™n Twitter`;
            previewContainer.appendChild(countInfo);
        }

        function clearAll() {
            const tweetText = document.getElementById('tweetText');
            const imageUrls = document.getElementById('imageUrls');
            const pageDataList = document.getElementById('pageDataList');
            const articlesTableBody = document.getElementById('articlesTableBody');
            const previewArea = document.getElementById('imagePreviewArea');
            
            if (tweetText) tweetText.value = '';
            if (imageUrls) imageUrls.value = '';
            if (pageDataList) pageDataList.style.display = 'none';
            if (articlesTableBody) articlesTableBody.innerHTML = '';
            if (previewArea) previewArea.style.display = 'none';
            
            pageArticles = [];
            allArticlesContent = [];
            currentUsedIndex = -1;
            updateCharCount();
        }

        function toggleSchedule() {
            const section = document.getElementById('scheduleSection');
            if (!section) return;
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                
                // Set default date/time (1 hour from now)
                const now = new Date();
                now.setHours(now.getHours() + 1);
                
                const scheduleDate = document.getElementById('scheduleDate');
                const scheduleTime = document.getElementById('scheduleTime');
                
                if (scheduleDate) scheduleDate.value = now.toISOString().split('T')[0];
                if (scheduleTime) scheduleTime.value = now.toTimeString().slice(0, 5);
            } else {
                section.style.display = 'none';
            }
        }

        async function fetchPageData() {
            const baseUrl = document.getElementById('apiBaseUrl');
            const page = document.getElementById('apiPage');
            const limit = document.getElementById('apiLimit');

            if (!baseUrl || !baseUrl.value.trim()) {
                return showPostMessage('‚ö†Ô∏è Vui l√≤ng nh·∫≠p URL API.', 'error');
            }

            try {
                showPostMessage(`üì° ƒêang l·∫•y ${limit.value} b√†i t·ª´ page ${page.value}...`, 'success');

                const apiUrl = baseUrl.value.trim() + '&pg=' + page.value;
                const res = await fetch('/api/fetch-page-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        apiUrl: apiUrl,
                        limit: limit.value 
                    })
                });
                const data = await res.json();

                if (!res.ok || !data.success) {
                    throw new Error(data.error || 'Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ API');
                }

                pageArticles = data.articles;
                console.log('üìã D·ªØ li·ªáu pageArticles:', pageArticles);
                displayArticlesTable(data.articles);

                const pageDataList = document.getElementById('pageDataList');
                if (pageDataList) pageDataList.style.display = 'block';
                
                showPostMessage(`‚úÖ ƒê√£ l·∫•y ${data.articles.length}/${limit.value} b√†i vi·∫øt t·ª´ page ${page.value}!`, 'success');

                // T·ª± ƒë·ªông t·∫°o n·ªôi dung cho t·∫•t c·∫£ b√†i vi·∫øt
                if (data.articles.length > 0) {
                    showPostMessage(`üìù ƒêang t·ª± ƒë·ªông t·∫°o n·ªôi dung cho ${data.articles.length} b√†i vi·∫øt...`, 'success');
                    setTimeout(() => {
                        generateAllArticlesContent();
                    }, 500);
                }
            } catch (err) {
                console.error(err);
                showPostMessage('‚ùå ' + err.message, 'error');
            }
        }

        async function generateAllArticlesContent() {
            allArticlesContent = [];
            
            for (let i = 0; i < pageArticles.length; i++) {
                const article = pageArticles[i];
                const title = article.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ';
                
                showPostMessage(`üìù T·∫°o n·ªôi dung cho b√†i ${i + 1}/${pageArticles.length}: ${title.substring(0, 30)}...`, 'success');
                
                // Use predefined Chinese content directly
                const aiContent = getRandomChineseContent();
                allArticlesContent[i] = aiContent;
                updateArticleRowStatus(i, 'completed');
                
                if (i < pageArticles.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            useArticleWithPreGeneratedContent(0);
            showPostMessage(`‚úÖ ƒê√£ t·∫°o xong n·ªôi dung cho ${pageArticles.length} b√†i vi·∫øt!`, 'success');
        }

        function displayArticlesTable(articles) {
            const tbody = document.getElementById('articlesTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            articles.forEach((article, index) => {
                const row = document.createElement('tr');
                row.id = `article-row-${index}`;
                
                const isFirst = index === 0;
                const baseStyle = isFirst ? 
                    'border-bottom: 1px solid var(--border-color); transition: background-color 0.2s; background-color: var(--hover-bg);' :
                    'border-bottom: 1px solid var(--border-color); transition: background-color 0.2s;';
                
                row.style.cssText = baseStyle;
                row.onmouseover = function() { 
                    if (currentUsedIndex !== index) {
                        this.style.backgroundColor = 'var(--hover-bg)'; 
                    }
                };
                row.onmouseout = function() { 
                    if (currentUsedIndex === index) {
                        this.style.backgroundColor = 'var(--bg-secondary)';
                    } else if (index === 0 && currentUsedIndex === -1) {
                        this.style.backgroundColor = 'var(--hover-bg)';
                    } else {
                        this.style.backgroundColor = 'transparent';
                    }
                };

                const title = article.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ';
                const imageCount = article.images ? Math.min(article.images.length, 4) : 0;
                
                let imagePreview = '';
                if (article.images && article.images.length > 0) {
                    const imagesToShow = article.images.slice(0, 4);
                    imagePreview = '<div style="display: flex; gap: 2px; flex-wrap: wrap; width: 120px;">';
                    imagesToShow.forEach((img, i) => {
                        imagePreview += `<img src="${img}" style="width: 28px; height: 28px; object-fit: cover; border-radius: 2px; border: 1px solid var(--border-color);" onerror="this.style.display='none'" title="·∫¢nh ${i+1}">`;
                    });
                    imagePreview += '</div>';
                } else {
                    imagePreview = '<div style="width: 60px; height: 40px; background: var(--bg-secondary); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 12px;">No img</div>';
                }

                const statusBadge = isFirst ? 
                    '<span style="background: #ffc107; color: #000; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 8px;">AUTO</span>' : '';

                row.innerHTML = `
                    <td style="padding: 15px; font-weight: 600; color: var(--text-primary);">${index + 1}${statusBadge}</td>
                    <td style="padding: 15px; max-width: 300px;">
                        <div style="font-weight: 500; color: var(--text-primary); line-height: 1.4;">
                            ${title.length > 80 ? title.substring(0, 80) + '...' : title}
                        </div>
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        ${imagePreview}
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        <span style="background: ${imageCount > 0 ? '#28a745' : '#6c757d'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">
                            ${imageCount}
                        </span>
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        <button onclick="useArticle(${index})" style="background: #ffc107; color: #000; border: 1px solid #ffc107; padding: 8px 16px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                            <i class="fas fa-arrow-down"></i> S·ª≠ d·ª•ng
                        </button>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        function updateArticleRowStatus(index, status) {
            const row = document.getElementById(`article-row-${index}`);
            if (!row) return;
            
            const statusCell = row.cells[0];
            const currentContent = statusCell.innerHTML;
            
            let statusBadge = '';
            if (status === 'completed') {
                statusBadge = '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 8px;">‚úì OK</span>';
            } else if (status === 'error') {
                statusBadge = '<span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 8px;">‚ö† ERR</span>';
            }
            
            const cleanContent = currentContent.replace(/<span[^>]*>(AUTO|‚úì AI|‚ö† TPL)<\/span>/g, '');
            statusCell.innerHTML = cleanContent + statusBadge;
        }

        async function useArticle(index) {
            if (allArticlesContent[index]) {
                useArticleWithPreGeneratedContent(index);
                return;
            }
            
            const article = pageArticles[index];
            if (!article) {
                console.error('‚ùå Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt t·∫°i index:', index);
                return showPostMessage('‚ùå Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt!', 'error');
            }

            const title = article.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ';
            showPostMessage('üìù ƒêang t·∫°o n·ªôi dung theo ti√™u ƒë·ªÅ...', 'success');

            // Use predefined Chinese content directly
            const chineseContent = getRandomChineseContent();
            allArticlesContent[index] = chineseContent;
            updateArticleRowStatus(index, 'completed');
            
            useArticleWithPreGeneratedContent(index);
        }

        function useArticleWithPreGeneratedContent(index) {
            const article = pageArticles[index];
            if (!article) return;

            const title = article.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ';
            const aiContent = allArticlesContent[index] || getRandomChineseContent();
            
            const tweetTextElement = document.getElementById('tweetText');
            if (tweetTextElement) {
                const tweetContent = `${title}\n\n${aiContent}`;
                tweetTextElement.value = tweetContent;
                updateCharCount();
            }

            const imageUrlsElement = document.getElementById('imageUrls');
            if (imageUrlsElement) {
                if (article.images && article.images.length > 0) {
                    const imageUrls = article.images.slice(0, 4).join('\n');
                    imageUrlsElement.value = imageUrls;
                    // Trigger preview
                    previewImages();
                } else {
                    imageUrlsElement.value = '';
                    // Hide preview
                    const previewArea = document.getElementById('imagePreviewArea');
                    if (previewArea) previewArea.style.display = 'none';
                }
            }

            if (currentUsedIndex >= 0) {
                const oldRow = document.getElementById(`article-row-${currentUsedIndex}`);
                if (oldRow) oldRow.style.backgroundColor = 'transparent';
            }
            currentUsedIndex = index;
            const currentRow = document.getElementById(`article-row-${index}`);
            if (currentRow) currentRow.style.backgroundColor = 'var(--bg-secondary)';

            setTimeout(() => {
                const tweetCard = document.querySelector('.card:last-child');
                if (tweetCard) {
                    tweetCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);

            const shortTitle = title.length > 50 ? title.substring(0, 50) + '...' : title;
            const actualImageCount = article.images ? Math.min(article.images.length, 4) : 0;
            showPostMessage(`‚úÖ ƒê√£ s·ª≠ d·ª•ng n·ªôi dung AI: ${shortTitle} | ${actualImageCount} ·∫£nh`, 'success');
        }

        async function autoCreateSchedule() {
            const baseUrl = document.getElementById('apiBaseUrl');
            const page = document.getElementById('apiPage');
            const limit = document.getElementById('apiLimit');

            if (!baseUrl || !baseUrl.value.trim()) {
                return showPostMessage('‚ö†Ô∏è Vui l√≤ng nh·∫≠p URL API.', 'error');
            }

            if (!confirm(`üöÄ T·ª∞ ƒê·ªòNG ƒêƒÇNG 1 B√ÄI\n\nüìã Quy tr√¨nh:\n‚Ä¢ L·∫•y 1 b√†i t·ª´ API (page ${page.value})\n‚Ä¢ S·ª≠ d·ª•ng n·ªôi dung ti·∫øng Trung c√≥ s·∫µn\n‚Ä¢ Upload 4 ·∫£nh tr·ª±c ti·∫øp\n‚Ä¢ ƒêƒÉng l√™n Twitter ngay\n\n‚úÖ X√°c nh·∫≠n ti·∫øp t·ª•c?`)) {
                return;
            }

            try {
                showPostMessage('üöÄ ƒêang t·ª± ƒë·ªông ƒëƒÉng 1 b√†i...', 'success');

                const res = await fetch('/api/auto-post-now', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        apiUrl: baseUrl.value.trim(),
                        page: page.value,
                        limit: limit.value
                    })
                });
                const data = await res.json();

                if (!res.ok || !data.success) {
                    throw new Error(data.error || 'Kh√¥ng th·ªÉ t·ª± ƒë·ªông ƒëƒÉng');
                }

                let successMsg = `üéâ ${data.message}`;
                if (data.tweetId) {
                    successMsg += `\n\nüìä Chi ti·∫øt:\n‚Ä¢ Tweet ID: ${data.tweetId}\n‚Ä¢ Ti√™u ƒë·ªÅ: ${data.title}\n‚Ä¢ S·ªë ·∫£nh: ${data.imageCount}`;
                }
                
                showPostMessage(successMsg, 'success');
                
                // Update dashboard stats
                loadDashboardStats();

            } catch (err) {
                console.error(err);
                showPostMessage('‚ùå ' + err.message, 'error');
            }
        }

        async function scheduleTweet() {
            const text = document.getElementById('tweetText');
            const imageUrls = document.getElementById('imageUrls');
            const scheduleDate = document.getElementById('scheduleDate');
            const scheduleTime = document.getElementById('scheduleTime');

            if (!text || !text.value.trim()) {
                return showPostMessage('‚ö†Ô∏è Vui l√≤ng nh·∫≠p n·ªôi dung tweet.', 'error');
            }

            if (!scheduleDate || !scheduleTime || !scheduleDate.value || !scheduleTime.value) {
                return showPostMessage('‚ö†Ô∏è Vui l√≤ng ch·ªçn ng√†y v√† gi·ªù ƒëƒÉng.', 'error');
            }

            const scheduledTime = new Date(`${scheduleDate.value}T${scheduleTime.value}`);
            if (scheduledTime <= new Date()) {
                return showPostMessage('‚ö†Ô∏è Th·ªùi gian ƒëƒÉng ph·∫£i trong t∆∞∆°ng lai.', 'error');
            }

            try {
                showPostMessage('üìÖ ƒêang l·∫≠p l·ªãch tweet...', 'success');

                const res = await fetch('/api/twitter/schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text.value,
                        imageUrls: imageUrls ? imageUrls.value : '',
                        scheduledTime: scheduledTime.toISOString()
                    })
                });
                const data = await res.json();

                if (!res.ok || !data.success) {
                    throw new Error(data.error || 'Kh√¥ng th·ªÉ l·∫≠p l·ªãch tweet');
                }

                showPostMessage(`‚úÖ ${data.message}`, 'success');
                toggleSchedule();
                
                // Update dashboard stats
                loadDashboardStats();

            } catch (err) {
                console.error(err);
                showPostMessage('‚ùå ' + err.message, 'error');
            }
        }

        async function postTweet() {
            const text = document.getElementById('tweetText');
            const imageUrls = document.getElementById('imageUrls');

            if (!text || !text.value.trim()) {
                return showPostMessage('‚ö†Ô∏è Vui l√≤ng nh·∫≠p n·ªôi dung tweet.', 'error');
            }
            if (text.value.length > 280) {
                return showPostMessage('‚ö†Ô∏è Tweet kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 280 k√Ω t·ª±.', 'error');
            }

            try {
                const formData = new FormData();
                formData.append('text', text.value);

                if (imageUrls && imageUrls.value.trim()) {
                    const urls = imageUrls.value.split('\n')
                        .map(u => u.trim())
                        .filter(u => u && u.startsWith('http'))
                        .slice(0, 4);

                    if (urls.length > 0) {
                        formData.append('imageUrls', JSON.stringify(urls));
                    }
                }

                showPostMessage('‚è≥ ƒêang x·ª≠ l√Ω v√† ƒëƒÉng tweet...', 'success');

                const res = await fetch('/api/twitter/post', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (!res.ok || !data.success) {
                    throw new Error(data.error || 'Kh√¥ng th·ªÉ ƒëƒÉng tweet');
                }

                let msg = '‚úÖ ƒê√£ ƒëƒÉng tweet th√†nh c√¥ng!';
                if (data.imageCount > 0) {
                    msg = `‚úÖ ƒê√£ ƒëƒÉng tweet k√®m ${data.imageCount} ·∫£nh th√†nh c√¥ng!`;
                }
                msg += ` (ID: ${data.tweetId})`;
                showPostMessage(msg, 'success');

                clearAll();
                
                // Update dashboard stats
                loadDashboardStats();
            } catch (err) {
                console.error(err);
                showPostMessage('‚ùå ' + err.message, 'error');
            }
        }
    </script>
</body>

</html>